---
phase: 05-auth-enhancements
plan: 05
type: execute
wave: 3
depends_on: ["05-03", "05-04"]
files_modified:
  - src/app/auth/verify-2fa/page.tsx
  - src/app/auth/login/page.tsx
  - src/app/auth/callback/route.ts
autonomous: true

must_haves:
  truths:
    - "User with 2FA is redirected to verify-2fa after login"
    - "User can enter TOTP code on verify-2fa page"
    - "Successful 2FA verification redirects to dashboard"
    - "Forgot password link visible on login page"
  artifacts:
    - path: "src/app/auth/verify-2fa/page.tsx"
      provides: "2FA verification page for login"
      min_lines: 60
    - path: "src/app/auth/login/page.tsx"
      provides: "Updated login with forgot password link"
      contains: "forgot-password"
  key_links:
    - from: "src/app/auth/login/page.tsx"
      to: "/auth/forgot-password"
      via: "Link component"
      pattern: "href.*forgot-password"
    - from: "src/app/auth/verify-2fa/page.tsx"
      to: "src/components/auth/TwoFactorVerify.tsx"
      via: "Component import"
      pattern: "import.*TwoFactorVerify"
---

<objective>
Create 2FA verification page and update login flow for complete auth enhancement.

Purpose: Complete the login flow with 2FA support. When a user with 2FA enabled logs in, they need to verify with TOTP before accessing the dashboard. Also add forgot password link to login page.

Output: verify-2fa page for login-time 2FA, updated login page with forgot password link.
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auth-enhancements/05-RESEARCH.md
@.planning/phases/05-auth-enhancements/05-01-SUMMARY.md

# Reference existing auth flow:
@src/app/auth/login/page.tsx
@src/app/auth/verify/page.tsx
@src/middleware.ts

# Reference 2FA components:
@src/components/auth/TwoFactorVerify.tsx
@src/hooks/use-mfa.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verify-2fa page</name>
  <files>src/app/auth/verify-2fa/page.tsx</files>
  <action>
Create 2FA verification page for login flow.

This page is shown when a user with 2FA enabled successfully completes first-factor auth (OTP) but needs to complete second-factor (TOTP).

Structure:
- "use client" directive
- Same card layout as other auth pages
- Use TwoFactorVerify component from 05-03
- Handle onSuccess by redirecting to intended destination

Implementation:
- Check if user has session (redirect to login if not)
- Check AAL - if already aal2, redirect to dashboard
- Use useMFA hook to check needsVerification
- Render TwoFactorVerify component
- On success: redirect to sessionStorage.redirectAfterAuth or /dashboard

Handle edge cases:
- No session -> redirect to /auth/login
- Already aal2 -> redirect to /dashboard
- No MFA enrolled -> redirect to /dashboard (shouldn't happen but handle gracefully)

Hebrew copy:
- Title (in TwoFactorVerify): "אימות דו-שלבי"
- Loading state: "טוען..."
  </action>
  <verify>
Page renders at /auth/verify-2fa
Redirects if no session or already aal2
TwoFactorVerify component displays
Successful verification redirects to dashboard
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
verify-2fa page handles login-time 2FA challenge
Proper redirects for edge cases
Clean integration with TwoFactorVerify component
  </done>
</task>

<task type="auto">
  <name>Task 2: Update login page with forgot password link</name>
  <files>src/app/auth/login/page.tsx</files>
  <action>
Update login page to add forgot password link.

Add "שכחתי סיסמה" link below the login form.

Location: Below the form but above the "חזרה לדף הבית" link.

Implementation:
```jsx
<div className="mt-4 text-center">
  <Link
    href="/auth/forgot-password"
    className="text-sm text-muted-foreground hover:text-foreground transition-colors"
  >
    שכחתי סיסמה
  </Link>
</div>
```

Note: This link is relevant even though app is OTP-based because:
1. We're adding optional password auth in this phase
2. Users who set passwords (in security settings) will need this
3. It's standard UX to have this link visible

Place the link in the CardContent, after the Tabs component and before the "חזרה לדף הבית" link.
  </action>
  <verify>
"שכחתי סיסמה" link visible on login page
Link navigates to /auth/forgot-password
Link styling consistent with existing page
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Login page has forgot password link
Link positioned appropriately
  </done>
</task>

<task type="auto">
  <name>Task 3: Add AAL check to auth callback</name>
  <files>src/app/auth/callback/route.ts</files>
  <action>
Update auth callback to check AAL and redirect to verify-2fa if needed.

The callback route handles Supabase auth redirects (magic links, OAuth, etc.).

After successful auth callback:
1. Get session from Supabase
2. Check AAL: `supabase.auth.mfa.getAuthenticatorAssuranceLevel()`
3. If nextLevel is 'aal2' and currentLevel is 'aal1', redirect to /auth/verify-2fa
4. Otherwise, continue to normal redirect

Find the existing redirect logic in the callback and add AAL check before final redirect.

Pseudo-code:
```typescript
// After session is established
const { data: aalData } = await supabase.auth.mfa.getAuthenticatorAssuranceLevel()

if (aalData?.nextLevel === 'aal2' && aalData?.currentLevel !== aalData.nextLevel) {
  // User has MFA but needs to verify
  return NextResponse.redirect(new URL('/auth/verify-2fa', request.url))
}

// Continue with normal redirect
```

Be careful to preserve existing redirect logic (redirect params, etc.).
  </action>
  <verify>
Callback route includes AAL check
Users with MFA redirect to verify-2fa
Users without MFA continue to normal flow
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Auth callback checks AAL and routes to 2FA verification when needed
Existing redirect behavior preserved for non-MFA users
  </done>
</task>

</tasks>

<verification>
1. Login page shows "שכחתי סיסמה" link
2. Link navigates to /auth/forgot-password
3. verify-2fa page renders correctly
4. Auth callback handles AAL check
5. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- Forgot password link visible on login page
- verify-2fa page handles login-time 2FA
- Auth callback routes MFA users to verify-2fa
- Complete flow: login -> OTP verify -> 2FA verify -> dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/05-auth-enhancements/05-05-SUMMARY.md`
</output>
