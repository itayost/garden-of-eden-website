---
phase: 05-auth-enhancements
plan: 03
type: execute
wave: 2
depends_on: ["05-02"]
files_modified:
  - src/components/auth/TwoFactorSetup.tsx
  - src/components/auth/TwoFactorVerify.tsx
  - src/components/auth/TwoFactorDisable.tsx
autonomous: true

must_haves:
  truths:
    - "User can see QR code during 2FA setup"
    - "User can enter TOTP code to verify enrollment"
    - "User can enter TOTP code during login verification"
    - "User can disable 2FA with confirmation"
  artifacts:
    - path: "src/components/auth/TwoFactorSetup.tsx"
      provides: "2FA enrollment flow with QR code"
      min_lines: 100
    - path: "src/components/auth/TwoFactorVerify.tsx"
      provides: "TOTP code entry for login"
      min_lines: 60
    - path: "src/components/auth/TwoFactorDisable.tsx"
      provides: "2FA disable dialog"
      min_lines: 50
  key_links:
    - from: "src/components/auth/TwoFactorSetup.tsx"
      to: "src/lib/auth/mfa.ts"
      via: "enrollMFA, verifyMFA imports"
      pattern: "import.*enrollMFA.*verifyMFA"
    - from: "src/components/auth/TwoFactorVerify.tsx"
      to: "src/lib/auth/mfa.ts"
      via: "verifyMFA, listFactors imports"
      pattern: "import.*verifyMFA"
---

<objective>
Create 2FA components for enrollment, verification, and disabling.

Purpose: Provide reusable UI components for the 2FA flow. TwoFactorSetup handles initial enrollment with QR code display, TwoFactorVerify handles login-time 2FA challenge, TwoFactorDisable handles removing 2FA.

Output: Three components that use the MFA helpers from plan 02.
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auth-enhancements/05-RESEARCH.md

# Reference MFA helpers from plan 02:
@src/lib/auth/mfa.ts
@src/hooks/use-mfa.ts

# Reference existing UI patterns:
@src/app/auth/login/page.tsx
@src/app/auth/verify/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TwoFactorSetup component</name>
  <files>src/components/auth/TwoFactorSetup.tsx</files>
  <action>
Create 2FA enrollment component with multi-step flow.

Props:
```typescript
interface TwoFactorSetupProps {
  onSuccess: () => void;
  onCancel: () => void;
}
```

Flow (3 steps):
1. **Intro step**: Explain what 2FA is, show "התחל הגדרה" button
2. **QR step**: Show QR code SVG, instructions to scan with authenticator app, manual secret fallback, "המשך" button
3. **Verify step**: 6-digit code input, "אמת והפעל" button

Implementation:
- useState for step: 'intro' | 'qr' | 'verify'
- Call enrollMFA() when moving to QR step (store factorId, qrCode)
- Call verifyMFA(factorId, code) on verify submit
- Show loading states during API calls
- Call onSuccess() after successful verification

UI details:
- Use Card for container (consistent with auth pages)
- QR code: Render SVG directly using dangerouslySetInnerHTML (safe - from Supabase)
- Manual secret: Show copyable text for manual entry
- Code input: 6 separate inputs or single input with maxLength 6, dir="ltr"
- Validation: Only allow 6 digits
- Error display: Show inline error message below code input

Hebrew copy:
- Intro title: "אימות דו-שלבי"
- Intro description: "הוסיפו שכבת אבטחה נוספת לחשבון שלכם"
- QR title: "סרקו את קוד ה-QR"
- QR instruction: "סרקו עם אפליקציית האימות שלכם (Google Authenticator, Authy וכו')"
- Manual fallback: "לא מצליחים לסרוק? הזינו ידנית:"
- Verify title: "הזינו את קוד האימות"
- Verify instruction: "הזינו את הקוד בן 6 הספרות מאפליקציית האימות"
- Success: "אימות דו-שלבי הופעל בהצלחה"
  </action>
  <verify>
Component renders all 3 steps
QR code displays correctly
Code input accepts only 6 digits
API calls work (enrollMFA, verifyMFA)
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
TwoFactorSetup provides complete enrollment flow
QR code and manual secret both available
Verification step validates and enables 2FA
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TwoFactorVerify component</name>
  <files>src/components/auth/TwoFactorVerify.tsx</files>
  <action>
Create 2FA verification component for login flow.

Props:
```typescript
interface TwoFactorVerifyProps {
  onSuccess: () => void;
  onCancel?: () => void;  // Optional - may not allow cancel during login
}
```

This component is used during login when user has MFA enabled but hasn't verified this session (aal1 -> aal2).

Implementation:
- On mount, call listFactors() to get user's TOTP factor ID
- Show 6-digit code input
- On submit, call verifyMFA(factorId, code)
- Call onSuccess() after successful verification
- Show loading states during API calls

UI details:
- Card layout consistent with auth pages
- Shield icon or lock icon
- 6-digit code input with dir="ltr"
- "אמת" button with loading state
- Error message display for invalid codes

Hebrew copy:
- Title: "אימות דו-שלבי"
- Description: "הזינו את קוד האימות מאפליקציית האימות שלכם"
- Button: "אמת"
- Error: "קוד אימות שגוי"
  </action>
  <verify>
Component renders code input
Fetches factor ID on mount
Verifies code via API
Calls onSuccess after successful verification
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
TwoFactorVerify provides login-time 2FA challenge
Fetches correct factor and verifies code
Clean UI consistent with auth pages
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TwoFactorDisable component</name>
  <files>src/components/auth/TwoFactorDisable.tsx</files>
  <action>
Create 2FA disable confirmation component.

Props:
```typescript
interface TwoFactorDisableProps {
  factorId: string;
  onSuccess: () => void;
  onCancel: () => void;
}
```

Use AlertDialog pattern (established in prior phases for destructive actions).

Implementation:
- AlertDialog with trigger (rendered externally, this is the dialog content)
- Warning message about disabling 2FA
- Require current TOTP code for confirmation (security measure)
- Call unenrollFactor(factorId) on confirm
- Call onSuccess() after successful unenrollment

UI pattern - follow AlertDialog pattern from 02-04:
- AlertDialogHeader with title and description
- Code input for verification
- AlertDialogFooter with cancel and confirm buttons
- Loading state on confirm button

Hebrew copy:
- Title: "ביטול אימות דו-שלבי"
- Description: "הזינו את קוד האימות הנוכחי כדי לבטל את האימות הדו-שלבי"
- Warning: "שימו לב: ביטול האימות הדו-שלבי יפחית את אבטחת החשבון שלכם"
- Cancel: "ביטול"
- Confirm: "בטל אימות דו-שלבי"
  </action>
  <verify>
Component renders as AlertDialog
Requires TOTP code for confirmation
Calls unenrollFactor on confirm
Calls onSuccess after successful disable
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
TwoFactorDisable provides secure 2FA removal
Requires current TOTP code for confirmation
Follows AlertDialog pattern from prior phases
  </done>
</task>

</tasks>

<verification>
1. All 3 components render correctly in isolation
2. TypeScript compiles: `npx tsc --noEmit`
3. Components use MFA helpers from src/lib/auth/mfa.ts
4. UI patterns consistent with existing auth pages
</verification>

<success_criteria>
- TwoFactorSetup provides complete enrollment with QR code
- TwoFactorVerify handles login-time 2FA challenge
- TwoFactorDisable requires code confirmation for security
- All components have Hebrew text and RTL-aware inputs
- Error states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/05-auth-enhancements/05-03-SUMMARY.md`
</output>
