---
phase: 05-auth-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/auth/mfa.ts
  - src/hooks/use-mfa.ts
autonomous: true

must_haves:
  truths:
    - "MFA enrollment generates QR code SVG"
    - "MFA verification validates TOTP code"
    - "AAL check determines if 2FA is needed"
    - "Factor management lists and unenrolls factors"
  artifacts:
    - path: "src/lib/auth/mfa.ts"
      provides: "MFA server-side helpers"
      exports: ["enrollMFA", "verifyMFA", "listFactors", "unenrollFactor"]
      min_lines: 60
    - path: "src/hooks/use-mfa.ts"
      provides: "React hook for AAL check"
      exports: ["useMFA"]
      min_lines: 40
  key_links:
    - from: "src/lib/auth/mfa.ts"
      to: "supabase.auth.mfa"
      via: "Supabase client"
      pattern: "auth\\.mfa\\.(enroll|challenge|verify|listFactors|unenroll)"
    - from: "src/hooks/use-mfa.ts"
      to: "supabase.auth.mfa.getAuthenticatorAssuranceLevel"
      via: "Supabase client"
      pattern: "getAuthenticatorAssuranceLevel"
---

<objective>
Create MFA helper functions and React hook for managing two-factor authentication.

Purpose: Provide clean abstraction layer over Supabase MFA APIs. These helpers will be used by the 2FA setup components and login flow in subsequent plans.

Output: MFA utility functions (enrollMFA, verifyMFA, listFactors, unenrollFactor) and useMFA hook for AAL checking.
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auth-enhancements/05-RESEARCH.md

# Reference existing Supabase client patterns:
@src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MFA helper functions</name>
  <files>src/lib/auth/mfa.ts</files>
  <action>
Create MFA utility module with client-side functions wrapping Supabase MFA APIs.

Functions to create:

1. `enrollMFA(friendlyName?: string)`:
   - Calls `supabase.auth.mfa.enroll({ factorType: 'totp', friendlyName })`
   - Returns `{ factorId: string, qrCode: string, secret: string }` or `{ error: string }`
   - friendlyName defaults to "Authenticator App"

2. `verifyMFA(factorId: string, code: string)`:
   - Creates challenge: `supabase.auth.mfa.challenge({ factorId })`
   - Verifies code: `supabase.auth.mfa.verify({ factorId, challengeId, code })`
   - Returns `{ success: true }` or `{ error: string }`

3. `listFactors()`:
   - Calls `supabase.auth.mfa.listFactors()`
   - Returns `{ factors: Factor[] }` or `{ error: string }`
   - Factor type: `{ id: string, friendlyName: string | null, status: 'verified' | 'unverified', createdAt: string }`

4. `unenrollFactor(factorId: string)`:
   - Calls `supabase.auth.mfa.unenroll({ factorId })`
   - Calls `supabase.auth.refreshSession()` to downgrade AAL
   - Returns `{ success: true }` or `{ error: string }`

5. `getAAL()`:
   - Calls `supabase.auth.mfa.getAuthenticatorAssuranceLevel()`
   - Returns `{ currentLevel: 'aal1' | 'aal2', nextLevel: 'aal1' | 'aal2' }` or `{ error: string }`

All functions use createClient() from @/lib/supabase/client.

Use consistent error handling: try/catch with typed returns, never throw.
  </action>
  <verify>
File exists at src/lib/auth/mfa.ts
Exports all 5 functions
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
MFA helper functions provide clean interface to Supabase MFA APIs
All functions return typed results with error handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useMFA hook</name>
  <files>src/hooks/use-mfa.ts</files>
  <action>
Create React hook for MFA state management.

Hook signature:
```typescript
interface UseMFAReturn {
  // Current state
  hasMFA: boolean;          // User has verified TOTP factor
  needsVerification: boolean; // User has MFA but hasn't verified this session (aal1 -> aal2)
  factors: Factor[];        // List of enrolled factors
  isLoading: boolean;
  error: string | null;

  // Actions
  refresh: () => Promise<void>;
}
```

Implementation:
- On mount, call `listFactors()` and `getAAL()` from mfa.ts
- `hasMFA`: factors array has at least one verified TOTP factor
- `needsVerification`: currentLevel is 'aal1' but nextLevel is 'aal2'
- `refresh`: re-fetch factors and AAL (for use after enrollment/unenrollment)

Use useState for state, useEffect for initial fetch.
Handle loading state during async operations.
  </action>
  <verify>
File exists at src/hooks/use-mfa.ts
Exports useMFA hook
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
useMFA hook provides reactive MFA state for components
Hook correctly determines if user has MFA and needs verification
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Both files export correct functions/hooks
3. No circular dependencies
4. Functions follow existing codebase patterns (ActionResult-style returns)
</verification>

<success_criteria>
- MFA helpers wrap Supabase MFA APIs with clean interface
- useMFA hook provides reactive state for components
- All functions have typed returns with proper error handling
- No direct Supabase MFA calls needed in components
</success_criteria>

<output>
After completion, create `.planning/phases/05-auth-enhancements/05-02-SUMMARY.md`
</output>
