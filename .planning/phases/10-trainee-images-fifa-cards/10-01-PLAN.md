---
phase: 10-trainee-images-fifa-cards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/YYYYMMDDHHMMSS_trainee_images_infrastructure.sql
  - src/lib/utils/storage.ts
  - package.json
autonomous: true
user_setup:
  - service: remove.bg
    why: "Background removal API for FIFA card cutouts"
    env_vars:
      - name: REMOVEBG_API_KEY
        source: "https://www.remove.bg/dashboard#api-key (create account if needed)"

must_haves:
  truths:
    - "Admin/coach can upload images to any trainee's folder in storage"
    - "Storage utilities support processed image URLs alongside original"
    - "remove.bg package is installed and ready to use"
  artifacts:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_trainee_images_infrastructure.sql"
      provides: "RLS policies for admin/coach image uploads + processed_avatar_url column"
      contains: "CREATE POLICY"
    - path: "src/lib/utils/storage.ts"
      provides: "Extended storage utilities for dual image storage"
      exports: ["uploadTraineeImage", "uploadProcessedImage", "deleteTraineeImage"]
  key_links:
    - from: "storage.ts"
      to: "Supabase Storage"
      via: "supabase.storage.from('avatars')"
      pattern: "supabase\\.storage\\.from"
---

<objective>
Set up infrastructure for trainee image management: RLS policies allowing admin/coach uploads to any trainee folder, extend storage utilities for dual image storage (original + processed), add processed_avatar_url column to profiles table, and install remove.bg package.

Purpose: Foundation for all subsequent image upload and processing work
Output: Migration file, extended storage utilities, remove.bg dependency
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-trainee-images-fifa-cards/10-CONTEXT.md
@.planning/phases/10-trainee-images-fifa-cards/10-RESEARCH.md
@src/lib/utils/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for image infrastructure</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_trainee_images_infrastructure.sql</files>
  <action>
Create a migration file that:

1. Adds `processed_avatar_url` column to profiles table:
   - Type: TEXT
   - Nullable (not all users will have processed images)
   - Comment: "URL of background-removed cutout image for FIFA cards"

2. Creates RLS policies for admin/coach image uploads to avatars bucket:
   - Policy name: "Admins and trainers can upload trainee avatars"
   - FOR INSERT on storage.objects
   - Condition: bucket_id = 'avatars' AND user has admin or trainer role
   - Use existing pattern from project: `EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'trainer'))`

3. Creates RLS policies for admin/coach image updates:
   - Policy name: "Admins and trainers can update trainee avatars"
   - FOR UPDATE on storage.objects
   - Same condition as insert

4. Creates RLS policies for admin/coach image deletes:
   - Policy name: "Admins and trainers can delete trainee avatars"
   - FOR DELETE on storage.objects
   - Same condition

Use timestamp format YYYYMMDDHHMMSS with current timestamp for migration file name.
  </action>
  <verify>
Migration file exists in supabase/migrations/ with proper SQL syntax.
Run: `npx supabase migration new --help` to verify supabase CLI available (don't actually create, just verify)
  </verify>
  <done>
Migration file created with ALTER TABLE for processed_avatar_url column and 3 RLS policies for admin/trainer storage access.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend storage utilities for trainee images</name>
  <files>src/lib/utils/storage.ts</files>
  <action>
Extend the existing storage.ts file with new functions for trainee image management:

1. Add new constants:
   - MAX_TRAINEE_IMAGE_SIZE = 5 * 1024 * 1024 (5MB per CONTEXT.md)

2. Add `uploadTraineeImage` function:
   - Parameters: (traineeUserId: string, file: File)
   - Returns: Promise<{ url: string; path: string } | { error: string }>
   - Stores in `{traineeUserId}/original/{timestamp}.{ext}` path
   - Uses same validation pattern as existing uploadProfilePhoto
   - Increase max size to 5MB for this function

3. Add `uploadProcessedImage` function:
   - Parameters: (traineeUserId: string, imageBuffer: Buffer | Blob, format: 'png')
   - Returns: Promise<{ url: string; path: string } | { error: string }>
   - Stores in `{traineeUserId}/processed/{timestamp}.png` path
   - For server-side use after background removal

4. Add `deleteTraineeImage` function:
   - Parameters: (originalPath: string, processedPath?: string)
   - Returns: Promise<{ success: boolean } | { error: string }>
   - Deletes both original and processed images if both provided

5. Add `getProcessedAvatarUrl` function:
   - Parameters: (path: string | null)
   - Returns: string | null
   - Same pattern as existing getAvatarUrl

Keep all existing functions unchanged. Add new functions at the end of the file.
  </action>
  <verify>
TypeScript compiles without errors:
`npx tsc --noEmit src/lib/utils/storage.ts`
  </verify>
  <done>
storage.ts extended with uploadTraineeImage, uploadProcessedImage, deleteTraineeImage, and getProcessedAvatarUrl functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Install remove.bg package</name>
  <files>package.json</files>
  <action>
Install the remove.bg npm package:

```bash
npm install remove.bg
```

After installation, verify it's in package.json dependencies.

Note: The REMOVEBG_API_KEY environment variable setup will be handled by user during deployment. Document in .env.example if it exists, or create a note in the summary.
  </action>
  <verify>
Package installed:
`npm list remove.bg`
  </verify>
  <done>
remove.bg package installed and listed in package.json dependencies.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists and has valid SQL syntax
2. storage.ts exports new functions
3. remove.bg package is installed
4. No TypeScript errors in storage.ts
</verification>

<success_criteria>
- [ ] Migration adds processed_avatar_url column to profiles
- [ ] Migration creates 3 RLS policies for admin/trainer storage access
- [ ] storage.ts has uploadTraineeImage, uploadProcessedImage, deleteTraineeImage, getProcessedAvatarUrl
- [ ] remove.bg package installed
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-trainee-images-fifa-cards/10-01-SUMMARY.md`
</output>
