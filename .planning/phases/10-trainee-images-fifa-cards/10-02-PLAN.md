---
phase: 10-trainee-images-fifa-cards
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/app/api/images/process-background/route.ts
  - src/lib/actions/admin-images.ts
autonomous: true

must_haves:
  truths:
    - "API endpoint removes background from uploaded image"
    - "API endpoint requires admin or trainer role"
    - "Processed image is stored in Supabase Storage"
    - "Both original and processed URLs are returned"
  artifacts:
    - path: "src/app/api/images/process-background/route.ts"
      provides: "Background removal API endpoint"
      exports: ["POST"]
    - path: "src/lib/actions/admin-images.ts"
      provides: "Server action for updating profile avatar URLs"
      exports: ["updateTraineeAvatarUrls"]
  key_links:
    - from: "route.ts"
      to: "remove.bg"
      via: "removeBackgroundFromImageBase64"
      pattern: "removeBackgroundFromImageBase64"
    - from: "route.ts"
      to: "storage.ts"
      via: "uploadProcessedImage"
      pattern: "uploadProcessedImage"
---

<objective>
Create the background removal API endpoint that receives an image, removes its background using remove.bg, stores both original and processed versions, and returns URLs. Also create server action to update profile avatar URLs.

Purpose: Server-side image processing with secure API key handling
Output: API route for background removal, server action for profile updates
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-trainee-images-fifa-cards/10-CONTEXT.md
@.planning/phases/10-trainee-images-fifa-cards/10-RESEARCH.md
@.planning/phases/10-trainee-images-fifa-cards/10-01-SUMMARY.md
@src/lib/utils/storage.ts
@src/lib/actions/admin-users.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create background removal API endpoint</name>
  <files>src/app/api/images/process-background/route.ts</files>
  <action>
Create a Next.js API route that:

1. Accepts POST with FormData containing:
   - `image`: The image file
   - `traineeUserId`: The trainee's user ID

2. Verifies admin/trainer role:
   - Use pattern from existing admin actions
   - Get current user from Supabase auth
   - Check profile role is 'admin' or 'trainer'
   - Return 403 if unauthorized

3. Validates the image:
   - Check file exists
   - Check file type (JPEG, PNG only)
   - Check file size (max 5MB per CONTEXT.md)

4. Uploads original image:
   - Use uploadTraineeImage from storage.ts
   - Store in `{traineeUserId}/original/` path

5. Processes with remove.bg:
   - Convert file to base64 (without data:image prefix)
   - Call removeBackgroundFromImageBase64 with:
     - apiKey: process.env.REMOVEBG_API_KEY
     - size: "regular"
     - type: "person"
     - format: "png"
   - Handle errors gracefully (return error message, don't crash)

6. Uploads processed image:
   - Convert result base64 back to Buffer
   - Use uploadProcessedImage from storage.ts
   - Store in `{traineeUserId}/processed/` path

7. Returns JSON response:
   - Success: { originalUrl, processedUrl, originalPath, processedPath }
   - Error: { error: string } with appropriate status code

Error handling:
- 400 for validation errors (missing image, wrong format, too large)
- 403 for unauthorized
- 500 for processing errors (remove.bg failure)
- 429 for rate limit (if remove.bg returns 429)

Import removeBackgroundFromImageBase64 from "remove.bg" package.
  </action>
  <verify>
File exists and TypeScript compiles:
`npx tsc --noEmit src/app/api/images/process-background/route.ts`
  </verify>
  <done>
API endpoint created at /api/images/process-background with role verification, image validation, background removal, and dual storage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create server action for updating profile avatar URLs</name>
  <files>src/lib/actions/admin-images.ts</files>
  <action>
Create a new server action file for image-related admin operations:

1. Create `updateTraineeAvatarUrls` function:
   - Parameters: (traineeUserId: string, originalUrl: string, processedUrl: string)
   - Returns: Promise<{ success: true } | { error: string }>
   - Mark as "use server"

2. Implementation:
   - Verify admin/trainer role (use verifyAdmin pattern from admin-users.ts but also accept trainer)
   - Validate traineeUserId is valid UUID
   - Update profiles table:
     - Set avatar_url = originalUrl (for avatars throughout app)
     - Set processed_avatar_url = processedUrl (for FIFA cards)
   - Use Supabase admin client to bypass RLS for cross-user update

3. Error handling:
   - Return { error: "Unauthorized" } for non-admin/trainer
   - Return { error: "User not found" } if trainee doesn't exist
   - Return { error: "Failed to update profile" } for database errors

4. Add helper function `verifyAdminOrTrainer`:
   - Similar to verifyAdmin but accepts both roles
   - Returns { authorized: true, userId: string } or { authorized: false }
  </action>
  <verify>
File exists and TypeScript compiles:
`npx tsc --noEmit src/lib/actions/admin-images.ts`
  </verify>
  <done>
Server action created with updateTraineeAvatarUrls function and verifyAdminOrTrainer helper.
  </done>
</task>

</tasks>

<verification>
1. API route exists at src/app/api/images/process-background/route.ts
2. Server action exists at src/lib/actions/admin-images.ts
3. Both files compile without TypeScript errors
4. API route imports from remove.bg and storage.ts
5. Server action follows established patterns from admin-users.ts
</verification>

<success_criteria>
- [ ] POST /api/images/process-background endpoint created
- [ ] Endpoint verifies admin/trainer role
- [ ] Endpoint validates image (type, size)
- [ ] Endpoint uploads original image to storage
- [ ] Endpoint calls remove.bg API
- [ ] Endpoint uploads processed image to storage
- [ ] Endpoint returns both URLs on success
- [ ] updateTraineeAvatarUrls server action created
- [ ] Server action updates both avatar_url and processed_avatar_url
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-trainee-images-fifa-cards/10-02-SUMMARY.md`
</output>
