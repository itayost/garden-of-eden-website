---
phase: 04-data-export-assessments
plan: 05
type: execute
wave: 2
depends_on: ["04-03"]
files_modified:
  - src/lib/actions/admin-gdpr.ts
  - src/components/admin/exports/UserDataExportButton.tsx
  - src/app/admin/users/[userId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can export all data for a specific user"
    - "Export includes profile, forms (3 types), assessments, video progress"
    - "Export excludes activity logs, payments, goals, achievements (per CONTEXT.md)"
    - "Export downloads as JSON file"
  artifacts:
    - path: "src/lib/actions/admin-gdpr.ts"
      provides: "Server action to aggregate user data"
      exports: ["exportUserDataAction"]
    - path: "src/components/admin/exports/UserDataExportButton.tsx"
      provides: "GDPR export button component"
      min_lines: 50
  key_links:
    - from: "src/components/admin/exports/UserDataExportButton.tsx"
      to: "exportUserDataAction"
      via: "import and call"
      pattern: "exportUserDataAction"
---

<objective>
Add GDPR-compliant full data export per user.

Purpose: Allow admins to export all personal data for a specific user for GDPR compliance.
Output: Server action and button to export user data as JSON.
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-data-export-assessments/04-CONTEXT.md
@.planning/phases/04-data-export-assessments/04-RESEARCH.md

# Reference patterns:
@src/lib/actions/admin-users.ts (verifyAdmin pattern)
@src/components/admin/users/UserExportButton.tsx (export pattern)
@.planning/phases/04-data-export-assessments/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GDPR export server action</name>
  <files>src/lib/actions/admin-gdpr.ts</files>
  <action>
Create server action to aggregate all user data for GDPR export:

```tsx
"use server";

import { createClient } from "@/lib/supabase/server";
import { createAdminClient } from "@/lib/supabase/admin";
import type { Profile, PreWorkoutForm, PostWorkoutForm, NutritionForm } from "@/types/database";
import type { PlayerAssessment } from "@/types/assessment";

// UUID validation regex
const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

interface VideoProgress {
  id: string;
  user_id: string;
  video_id: string;
  watched: boolean;
  watched_at: string | null;
  created_at: string;
}

interface GDPRExportData {
  exportedAt: string;
  userId: string;
  profile: Profile | null;
  preWorkoutForms: PreWorkoutForm[];
  postWorkoutForms: PostWorkoutForm[];
  nutritionForms: NutritionForm[];
  assessments: PlayerAssessment[];
  videoProgress: VideoProgress[];
}

type ActionResult =
  | { success: true; data: GDPRExportData }
  | { error: string };

/**
 * Verify current user is authenticated and has admin role
 */
async function verifyAdmin() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { error: "לא מחובר" as const, user: null };
  }

  const { data: adminProfile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .single();

  if (adminProfile?.role !== "admin") {
    return { error: "נדרשת הרשאת מנהל" as const, user: null };
  }

  return { error: null, user };
}

/**
 * Export all user data for GDPR compliance
 *
 * Includes (per CONTEXT.md):
 * - Profile data
 * - Form submissions (pre_workout, post_workout, nutrition)
 * - Assessments (excluding soft-deleted)
 * - Video progress
 *
 * Excludes (per CONTEXT.md):
 * - Activity logs
 * - Payment history
 * - Goals
 * - Achievements
 */
export async function exportUserDataAction(userId: string): Promise<ActionResult> {
  // 1. Verify admin
  const { error: authError } = await verifyAdmin();
  if (authError) return { error: authError };

  // 2. Validate userId
  if (!UUID_REGEX.test(userId)) {
    return { error: "מזהה משתמש לא תקין" };
  }

  // 3. Fetch all user data
  const adminClient = createAdminClient();

  try {
    const [
      { data: profile },
      { data: preWorkoutForms },
      { data: postWorkoutForms },
      { data: nutritionForms },
      { data: assessments },
      { data: videoProgress },
    ] = await Promise.all([
      adminClient
        .from("profiles")
        .select("*")
        .eq("id", userId)
        .single() as unknown as { data: Profile | null },
      adminClient
        .from("pre_workout_forms")
        .select("*")
        .eq("user_id", userId)
        .order("submitted_at", { ascending: false }) as unknown as { data: PreWorkoutForm[] | null },
      adminClient
        .from("post_workout_forms")
        .select("*")
        .eq("user_id", userId)
        .order("submitted_at", { ascending: false }) as unknown as { data: PostWorkoutForm[] | null },
      adminClient
        .from("nutrition_forms")
        .select("*")
        .eq("user_id", userId)
        .order("submitted_at", { ascending: false }) as unknown as { data: NutritionForm[] | null },
      adminClient
        .from("player_assessments")
        .select("*")
        .eq("user_id", userId)
        .is("deleted_at", null)
        .order("assessment_date", { ascending: false }) as unknown as { data: PlayerAssessment[] | null },
      adminClient
        .from("video_progress")
        .select("*")
        .eq("user_id", userId) as unknown as { data: VideoProgress[] | null },
    ]);

    if (!profile) {
      return { error: "המשתמש לא נמצא" };
    }

    return {
      success: true,
      data: {
        exportedAt: new Date().toISOString(),
        userId,
        profile,
        preWorkoutForms: preWorkoutForms || [],
        postWorkoutForms: postWorkoutForms || [],
        nutritionForms: nutritionForms || [],
        assessments: (assessments || []) as PlayerAssessment[],
        videoProgress: videoProgress || [],
      },
    };
  } catch (error) {
    console.error("GDPR export error:", error);
    return { error: "שגיאה בייצוא הנתונים" };
  }
}
```
  </action>
  <verify>TypeScript compiles: `npm run build -- --no-emit 2>&1 | head -20`</verify>
  <done>exportUserDataAction server action created with all required data tables.</done>
</task>

<task type="auto">
  <name>Task 2: Create UserDataExportButton component</name>
  <files>src/components/admin/exports/UserDataExportButton.tsx</files>
  <action>
Create GDPR export button component:

```tsx
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { DatabaseZap, Loader2 } from "lucide-react";
import { toast } from "sonner";
import { exportUserDataAction } from "@/lib/actions/admin-gdpr";

interface UserDataExportButtonProps {
  userId: string;
  userName: string;
}

export function UserDataExportButton({ userId, userName }: UserDataExportButtonProps) {
  const [loading, setLoading] = useState(false);

  const handleExport = async () => {
    setLoading(true);
    try {
      const result = await exportUserDataAction(userId);

      if (!("success" in result)) {
        toast.error(result.error);
        return;
      }

      // Create JSON blob and download
      const jsonContent = JSON.stringify(result.data, null, 2);
      const blob = new Blob([jsonContent], { type: "application/json" });

      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `gdpr-export-${userName.replace(/\s+/g, "-")}-${new Date().toISOString().split("T")[0]}.json`;
      link.click();
      URL.revokeObjectURL(link.href);

      // Summary toast
      const { data } = result;
      const totalRecords =
        data.preWorkoutForms.length +
        data.postWorkoutForms.length +
        data.nutritionForms.length +
        data.assessments.length +
        data.videoProgress.length;

      toast.success(`יוצאו ${totalRecords} רשומות עבור ${userName}`);
    } catch (error) {
      console.error("GDPR export error:", error);
      toast.error("שגיאה בייצוא הנתונים");
    } finally {
      setLoading(false);
    }
  };

  return (
    <Button onClick={handleExport} variant="outline" disabled={loading}>
      {loading ? (
        <Loader2 className="h-4 w-4 ml-2 animate-spin" />
      ) : (
        <DatabaseZap className="h-4 w-4 ml-2" />
      )}
      {loading ? "מייצא..." : "ייצוא נתונים (GDPR)"}
    </Button>
  );
}
```
  </action>
  <verify>TypeScript compiles: `npm run build -- --no-emit 2>&1 | head -20`</verify>
  <done>UserDataExportButton component created with JSON download.</done>
</task>

<task type="auto">
  <name>Task 3: Add GDPR export to user profile page</name>
  <files>src/app/admin/users/[userId]/page.tsx</files>
  <action>
First, check if user profile page exists. If it exists, add the GDPR export button. If not, we'll add it to an appropriate location.

Check with: `ls src/app/admin/users/`

If `[userId]/page.tsx` exists:
1. Import UserDataExportButton
2. Add to the page's action buttons section

If it doesn't exist, we need to find where user details are displayed and add the button there. Look for:
- src/app/admin/users/page.tsx (main users list)
- Any user detail/profile component

For the main users list, add the export button to the UserActionsCard or similar component that shows user actions.

Search for where individual user actions are displayed:
```bash
grep -r "DeleteUserDialog" src/app/admin/users/
```

If there's a user detail page at `src/app/admin/users/[userId]/page.tsx`:

```tsx
// Add import at top
import { UserDataExportButton } from "@/components/admin/exports/UserDataExportButton";

// Find the actions section (likely near DeleteUserDialog) and add:
<UserDataExportButton userId={user.id} userName={user.full_name || "משתמש"} />
```

If no user detail page exists, add to the user actions in the users list. Find where DeleteUserDialog is rendered and add UserDataExportButton nearby.

Alternative: If there's a UserActionsCard component, add there:
```tsx
<UserDataExportButton userId={user.id} userName={user.full_name || "משתמש"} />
```

The button should be near other user-specific actions like delete, password reset, etc.
  </action>
  <verify>TypeScript compiles: `npm run build -- --no-emit 2>&1 | head -20`</verify>
  <done>GDPR export button visible on user profile/detail page.</done>
</task>

</tasks>

<verification>
1. Server action fetches all required data tables
2. Export excludes activity_logs, payments, goals, achievements
3. Button visible on user profile page
4. JSON file downloads with proper filename
</verification>

<success_criteria>
- GDPR export button visible for each user
- Clicking exports JSON with all personal data
- Export includes profile, 3 form types, assessments, video progress
- Export correctly excludes activity logs, payments, goals, achievements
- Toast shows record count summary
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-export-assessments/04-05-SUMMARY.md`
</output>
