---
phase: 04-data-export-assessments
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/admin/exports/SubmissionExportButton.tsx
  - src/app/admin/submissions/page.tsx
autonomous: true

must_haves:
  truths:
    - "Export button appears on submissions page"
    - "Date range filter allows filtering before export"
    - "CSV export includes all form fields with Hebrew headers"
    - "Excel opens exported file with Hebrew displayed correctly"
  artifacts:
    - path: "src/components/admin/exports/SubmissionExportButton.tsx"
      provides: "Export button with date filter for form submissions"
      min_lines: 80
    - path: "src/app/admin/submissions/page.tsx"
      provides: "Submissions page with export functionality"
      contains: "SubmissionExportButton"
  key_links:
    - from: "src/components/admin/exports/SubmissionExportButton.tsx"
      to: "papaparse"
      via: "Papa.unparse"
      pattern: "Papa\\.unparse"
---

<objective>
Add CSV export with date filtering to the form submissions page.

Purpose: Allow admins to export form submissions to CSV with optional date range filtering.
Output: SubmissionExportButton component and updated submissions page.
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-data-export-assessments/04-CONTEXT.md
@.planning/phases/04-data-export-assessments/04-RESEARCH.md

# Reference patterns:
@src/components/admin/users/UserExportButton.tsx (CSV export with BOM pattern)
@src/app/admin/submissions/page.tsx (page to modify)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SubmissionExportButton component</name>
  <files>src/components/admin/exports/SubmissionExportButton.tsx</files>
  <action>
Create a new directory `src/components/admin/exports/` and create SubmissionExportButton.tsx:

Follow UserExportButton.tsx pattern exactly for the CSV export logic.

Props interface:
```tsx
interface SubmissionExportButtonProps {
  formType: "pre_workout" | "post_workout" | "nutrition";
  submissions: PreWorkoutForm[] | PostWorkoutWithTrainer[] | NutritionForm[];
}
```

Import types from @/types/database. Create PostWorkoutWithTrainer type locally if needed.

Component features:
1. Date range filter with native HTML date inputs (per CONTEXT.md - "simple date picker, no presets")
2. Two inputs: startDate and endDate (state: useState(""))
3. Export button that:
   - Filters submissions by date range if provided
   - Maps data to Hebrew column names
   - Uses PapaParse unparse with BOM prefix for Hebrew Excel support

Date filtering logic:
```tsx
let filtered = submissions;
if (startDate) {
  filtered = filtered.filter(s => s.submitted_at >= startDate);
}
if (endDate) {
  // Include entire end day
  filtered = filtered.filter(s => s.submitted_at <= endDate + "T23:59:59");
}
```

Hebrew column mapping (different for each form type):

Pre-workout columns:
- "שם מלא": full_name
- "גיל": age
- "שעות שינה": sleep_hours
- "תזונה": nutrition_status (translated)
- "פציעה אחרונה": recent_injury
- "מוכנות לאימון (1-10)": readiness_level
- "תאריך הגשה": submitted_at (formatted DD/MM/YYYY)

Post-workout columns:
- "שם מלא": full_name
- "מאמן": trainers?.name
- "קושי (1-10)": difficulty_level
- "שביעות רצון (1-10)": satisfaction_level
- "הערות": comments
- "תאריך הגשה": submitted_at

Nutrition columns:
- "שם מלא": full_name
- "גיל": age
- "משקל": weight
- "גובה": height
- "אלרגיות": allergies (יש/אין)
- "פירוט אלרגיות": allergy_details
- "תאריך הגשה": submitted_at

File naming: `${formTypeToHebrew(formType)}-${formatDateForFilename(new Date())}.csv`

formTypeToHebrew helper:
- "pre_workout" -> "שאלון-לפני-אימון"
- "post_workout" -> "שאלון-אחרי-אימון"
- "nutrition" -> "שאלון-תזונה"

Nutrition status translations:
- "full_energy" -> "מלא אנרגיה"
- "insufficient" -> "לא מספיק"
- "no_energy" -> "אין אנרגיה"

Toast on export: `toast.success(\`יוצאו ${filtered.length} שאלונים\`)`
Empty state toast: `toast.error("אין נתונים לייצוא בטווח התאריכים שנבחר")`

UI layout (RTL):
```tsx
<div className="flex items-end gap-4 flex-wrap">
  <div>
    <Label htmlFor="start-date">מתאריך</Label>
    <Input
      id="start-date"
      type="date"
      value={startDate}
      onChange={(e) => setStartDate(e.target.value)}
      className="w-40"
    />
  </div>
  <div>
    <Label htmlFor="end-date">עד תאריך</Label>
    <Input
      id="end-date"
      type="date"
      value={endDate}
      onChange={(e) => setEndDate(e.target.value)}
      className="w-40"
    />
  </div>
  <Button onClick={handleExport} variant="outline">
    <Download className="h-4 w-4 ml-2" />
    ייצוא ל-CSV
  </Button>
</div>
```
  </action>
  <verify>TypeScript compiles: `npm run build -- --no-emit 2>&1 | head -20`</verify>
  <done>SubmissionExportButton component created with date filtering and Hebrew export.</done>
</task>

<task type="auto">
  <name>Task 2: Add export buttons to submissions page</name>
  <files>src/app/admin/submissions/page.tsx</files>
  <action>
Modify the submissions page to add export functionality for each tab:

1. Import SubmissionExportButton at the top:
   `import { SubmissionExportButton } from "@/components/admin/exports/SubmissionExportButton";`

2. For each TabsContent, add the export button in the CardHeader alongside the title:

Current CardHeader structure:
```tsx
<CardHeader>
  <CardTitle>שאלונים לפני אימון</CardTitle>
  <CardDescription>כל השאלונים שהוגשו לפני אימונים</CardDescription>
</CardHeader>
```

Change to include export button:
```tsx
<CardHeader>
  <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div>
      <CardTitle>שאלונים לפני אימון</CardTitle>
      <CardDescription>כל השאלונים שהוגשו לפני אימונים</CardDescription>
    </div>
    <SubmissionExportButton
      formType="pre_workout"
      submissions={preWorkout || []}
    />
  </div>
</CardHeader>
```

Apply same pattern to all three tabs:
- pre-workout tab: formType="pre_workout", submissions={preWorkout || []}
- post-workout tab: formType="post_workout", submissions={postWorkout || []}
- nutrition tab: formType="nutrition", submissions={nutrition || []}

3. Remove the .limit(50) from queries since we want all data for export:

Change each query from `.limit(50)` to no limit, or increase to reasonable amount like `.limit(1000)`.

Actually, better approach: keep the page limit but pass all submissions. If performance becomes an issue, can add server-side export later.

For now, just increase limit to 1000:
```tsx
.limit(1000)
```
  </action>
  <verify>TypeScript compiles: `npm run build -- --no-emit 2>&1 | head -20`</verify>
  <done>Export buttons visible on each submissions tab with date filtering.</done>
</task>

</tasks>

<verification>
1. SubmissionExportButton component exists in exports directory
2. Submissions page imports and uses export buttons
3. Each tab has its own export button with correct form type
4. TypeScript compiles without errors
</verification>

<success_criteria>
- Export button visible on each submissions tab
- Date range filter works (can select start/end dates)
- CSV export downloads with Hebrew column headers
- Excel opens file with Hebrew text displayed correctly (BOM prefix)
- Empty date filter shows toast error
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-export-assessments/04-03-SUMMARY.md`
</output>
