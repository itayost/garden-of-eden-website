---
phase: 04-data-export-assessments
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/admin/exports/AssessmentExportButton.tsx
  - src/components/admin/exports/AssessmentPdfButton.tsx
  - src/lib/exports/pdf-assessment-template.tsx
  - src/app/admin/assessments/[userId]/page.tsx
  - public/fonts/Heebo-Regular.ttf
  - public/fonts/Heebo-Bold.ttf
autonomous: true

must_haves:
  truths:
    - "CSV export button exports all assessments for a user"
    - "PDF export button generates branded PDF with RTL layout"
    - "CSV includes Hebrew column headers"
    - "PDF displays user name and all assessment data"
  artifacts:
    - path: "src/components/admin/exports/AssessmentExportButton.tsx"
      provides: "CSV export for user assessments"
      min_lines: 40
    - path: "src/components/admin/exports/AssessmentPdfButton.tsx"
      provides: "PDF export button"
      min_lines: 30
    - path: "src/lib/exports/pdf-assessment-template.tsx"
      provides: "PDF document template with RTL support"
      min_lines: 80
  key_links:
    - from: "src/components/admin/exports/AssessmentPdfButton.tsx"
      to: "pdf-assessment-template.tsx"
      via: "dynamic import and pdf generation"
      pattern: "AssessmentPdfDocument"
---

<objective>
Add CSV and PDF export functionality for user assessments.

Purpose: Allow admins to export a user's assessments as CSV (data) or PDF (branded report).
Output: Export components and PDF template with RTL Hebrew support.
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-data-export-assessments/04-CONTEXT.md
@.planning/phases/04-data-export-assessments/04-RESEARCH.md

# Reference patterns:
@src/components/admin/users/UserExportButton.tsx (CSV export pattern)
@src/types/assessment.ts (ASSESSMENT_LABELS_HE, COORDINATION_OPTIONS, etc.)
@src/app/admin/assessments/[userId]/page.tsx (page to modify)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @react-pdf/renderer and download Heebo font</name>
  <files>package.json, public/fonts/Heebo-Regular.ttf, public/fonts/Heebo-Bold.ttf</files>
  <action>
1. Install the PDF generation library:
```bash
npm install @react-pdf/renderer
```

2. Create fonts directory and download Heebo font files:
```bash
mkdir -p public/fonts
curl -L "https://github.com/nicholasn/heebo-font/raw/main/fonts/Heebo-Regular.ttf" -o public/fonts/Heebo-Regular.ttf
curl -L "https://github.com/nicholasn/heebo-font/raw/main/fonts/Heebo-Bold.ttf" -o public/fonts/Heebo-Bold.ttf
```

If the font download fails, use Google Fonts CDN alternative:
```bash
# Download from Google Fonts API
curl -L "https://fonts.gstatic.com/s/heebo/v22/NGS6v5_NC0k9P9H0TbFBsj8.ttf" -o public/fonts/Heebo-Regular.ttf
curl -L "https://fonts.gstatic.com/s/heebo/v22/NGS3v5_NC0k9P9H2TbFhsqMA.ttf" -o public/fonts/Heebo-Bold.ttf
```

Verify font files exist and are valid TTF files (should be >50KB each).
  </action>
  <verify>`npm list @react-pdf/renderer` shows installed. Font files exist in public/fonts/.</verify>
  <done>@react-pdf/renderer installed, Heebo font files in public/fonts/.</done>
</task>

<task type="auto">
  <name>Task 2: Create AssessmentExportButton (CSV)</name>
  <files>src/components/admin/exports/AssessmentExportButton.tsx</files>
  <action>
Create CSV export button for assessments following UserExportButton pattern:

```tsx
"use client";

import Papa from "papaparse";
import { Button } from "@/components/ui/button";
import { Download } from "lucide-react";
import { toast } from "sonner";
import {
  ASSESSMENT_LABELS_HE,
  COORDINATION_OPTIONS,
  BODY_STRUCTURE_OPTIONS,
} from "@/types/assessment";
import type { PlayerAssessment } from "@/types/assessment";

interface AssessmentExportButtonProps {
  playerName: string;
  assessments: PlayerAssessment[];
}

export function AssessmentExportButton({
  playerName,
  assessments,
}: AssessmentExportButtonProps) {
  const handleExport = () => {
    if (assessments.length === 0) {
      toast.error("אין מבדקים לייצוא");
      return;
    }

    // Helper for categorical values
    const getCategoricalLabel = (key: string, value: string | null): string => {
      if (!value) return "";
      switch (key) {
        case "coordination":
          return COORDINATION_OPTIONS.find((o) => o.value === value)?.label || value;
        case "body_structure":
          return BODY_STRUCTURE_OPTIONS.find((o) => o.value === value)?.label || value;
        default:
          return value;
      }
    };

    // Raw measurements only (per CONTEXT.md - no rankings)
    const csvData = assessments.map((a) => ({
      "שם שחקן": playerName,
      "תאריך מבדק": formatDateHebrew(a.assessment_date),
      [ASSESSMENT_LABELS_HE.sprint_5m]: a.sprint_5m ?? "",
      [ASSESSMENT_LABELS_HE.sprint_10m]: a.sprint_10m ?? "",
      [ASSESSMENT_LABELS_HE.sprint_20m]: a.sprint_20m ?? "",
      [ASSESSMENT_LABELS_HE.jump_2leg_distance]: a.jump_2leg_distance ?? "",
      [ASSESSMENT_LABELS_HE.jump_2leg_height]: a.jump_2leg_height ?? "",
      [ASSESSMENT_LABELS_HE.jump_right_leg]: a.jump_right_leg ?? "",
      [ASSESSMENT_LABELS_HE.jump_left_leg]: a.jump_left_leg ?? "",
      [ASSESSMENT_LABELS_HE.blaze_spot_time]: a.blaze_spot_time ?? "",
      [ASSESSMENT_LABELS_HE.flexibility_ankle]: a.flexibility_ankle ?? "",
      [ASSESSMENT_LABELS_HE.flexibility_knee]: a.flexibility_knee ?? "",
      [ASSESSMENT_LABELS_HE.flexibility_hip]: a.flexibility_hip ?? "",
      [ASSESSMENT_LABELS_HE.kick_power_kaiser]: a.kick_power_kaiser ?? "",
      [ASSESSMENT_LABELS_HE.coordination]: getCategoricalLabel("coordination", a.coordination),
      [ASSESSMENT_LABELS_HE.body_structure]: getCategoricalLabel("body_structure", a.body_structure),
      "הערות": a.notes ?? "",
    }));

    const csv = Papa.unparse(csvData);
    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });

    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `מבדקים-${playerName}-${formatDateForFilename(new Date())}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);

    toast.success(`יוצאו ${assessments.length} מבדקים`);
  };

  return (
    <Button onClick={handleExport} variant="outline" size="sm" disabled={assessments.length === 0}>
      <Download className="h-4 w-4 ml-2" />
      ייצוא CSV
    </Button>
  );
}

function formatDateHebrew(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString("he-IL", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  });
}

function formatDateForFilename(date: Date): string {
  return date.toISOString().split("T")[0];
}
```
  </action>
  <verify>TypeScript compiles: `npm run build -- --no-emit 2>&1 | head -20`</verify>
  <done>AssessmentExportButton component created with Hebrew columns.</done>
</task>

<task type="auto">
  <name>Task 3: Create PDF template and export button</name>
  <files>src/lib/exports/pdf-assessment-template.tsx, src/components/admin/exports/AssessmentPdfButton.tsx</files>
  <action>
Create two files for PDF export:

1. **src/lib/exports/pdf-assessment-template.tsx** - PDF document template:

```tsx
import {
  Document,
  Page,
  Text,
  View,
  StyleSheet,
  Font,
  Image,
} from "@react-pdf/renderer";
import type { PlayerAssessment } from "@/types/assessment";

// Register Hebrew font
Font.register({
  family: "Heebo",
  fonts: [
    { src: "/fonts/Heebo-Regular.ttf", fontWeight: 400 },
    { src: "/fonts/Heebo-Bold.ttf", fontWeight: 700 },
  ],
});

const styles = StyleSheet.create({
  page: {
    flexDirection: "column",
    backgroundColor: "#FFFFFF",
    padding: 30,
    fontFamily: "Heebo",
  },
  header: {
    flexDirection: "row-reverse", // RTL
    justifyContent: "space-between",
    alignItems: "center",
    marginBottom: 20,
    borderBottom: 2,
    borderBottomColor: "#22c55e", // Brand green
    paddingBottom: 15,
  },
  logo: {
    width: 60,
    height: 60,
  },
  headerText: {
    textAlign: "right",
  },
  title: {
    fontSize: 24,
    fontWeight: 700,
    color: "#22c55e",
    textAlign: "right",
  },
  subtitle: {
    fontSize: 14,
    color: "#6b7280",
    textAlign: "right",
    marginTop: 4,
  },
  playerName: {
    fontSize: 18,
    fontWeight: 700,
    textAlign: "right",
    marginBottom: 20,
  },
  table: {
    display: "flex",
    flexDirection: "column",
    marginTop: 10,
  },
  tableHeader: {
    flexDirection: "row-reverse", // RTL
    backgroundColor: "#f3f4f6",
    paddingVertical: 8,
    paddingHorizontal: 5,
    borderBottom: 1,
    borderBottomColor: "#e5e7eb",
  },
  tableRow: {
    flexDirection: "row-reverse", // RTL
    borderBottom: 1,
    borderBottomColor: "#e5e7eb",
    paddingVertical: 6,
    paddingHorizontal: 5,
  },
  tableCell: {
    flex: 1,
    textAlign: "right",
    fontSize: 9,
  },
  tableCellHeader: {
    flex: 1,
    textAlign: "right",
    fontSize: 9,
    fontWeight: 700,
  },
  sectionTitle: {
    fontSize: 12,
    fontWeight: 700,
    textAlign: "right",
    marginTop: 15,
    marginBottom: 5,
    color: "#22c55e",
  },
  footer: {
    position: "absolute",
    bottom: 20,
    left: 30,
    right: 30,
    textAlign: "center",
    fontSize: 8,
    color: "#9ca3af",
  },
});

interface AssessmentPdfDocumentProps {
  playerName: string;
  assessments: PlayerAssessment[];
  generatedAt: string;
}

export function AssessmentPdfDocument({
  playerName,
  assessments,
  generatedAt,
}: AssessmentPdfDocumentProps) {
  const formatDate = (dateStr: string) =>
    new Date(dateStr).toLocaleDateString("he-IL");

  return (
    <Document>
      <Page size="A4" style={styles.page}>
        {/* Header */}
        <View style={styles.header}>
          <View style={styles.headerText}>
            <Text style={styles.title}>דוח מבדקים</Text>
            <Text style={styles.subtitle}>Garden of Eden</Text>
          </View>
        </View>

        {/* Player name */}
        <Text style={styles.playerName}>{playerName}</Text>

        {/* Sprint section */}
        <Text style={styles.sectionTitle}>מבדקי ספרינט</Text>
        <View style={styles.table}>
          <View style={styles.tableHeader}>
            <Text style={styles.tableCellHeader}>תאריך</Text>
            <Text style={styles.tableCellHeader}>5 מטר</Text>
            <Text style={styles.tableCellHeader}>10 מטר</Text>
            <Text style={styles.tableCellHeader}>20 מטר</Text>
          </View>
          {assessments.map((a) => (
            <View key={a.id} style={styles.tableRow}>
              <Text style={styles.tableCell}>{formatDate(a.assessment_date)}</Text>
              <Text style={styles.tableCell}>{a.sprint_5m ?? "---"}</Text>
              <Text style={styles.tableCell}>{a.sprint_10m ?? "---"}</Text>
              <Text style={styles.tableCell}>{a.sprint_20m ?? "---"}</Text>
            </View>
          ))}
        </View>

        {/* Jump section */}
        <Text style={styles.sectionTitle}>מבדקי ניתור</Text>
        <View style={styles.table}>
          <View style={styles.tableHeader}>
            <Text style={styles.tableCellHeader}>תאריך</Text>
            <Text style={styles.tableCellHeader}>קפיצה לאורך</Text>
            <Text style={styles.tableCellHeader}>קפיצה לגובה</Text>
            <Text style={styles.tableCellHeader}>רגל ימין</Text>
            <Text style={styles.tableCellHeader}>רגל שמאל</Text>
          </View>
          {assessments.map((a) => (
            <View key={a.id} style={styles.tableRow}>
              <Text style={styles.tableCell}>{formatDate(a.assessment_date)}</Text>
              <Text style={styles.tableCell}>{a.jump_2leg_distance ?? "---"}</Text>
              <Text style={styles.tableCell}>{a.jump_2leg_height ?? "---"}</Text>
              <Text style={styles.tableCell}>{a.jump_right_leg ?? "---"}</Text>
              <Text style={styles.tableCell}>{a.jump_left_leg ?? "---"}</Text>
            </View>
          ))}
        </View>

        {/* Agility & Power section */}
        <Text style={styles.sectionTitle}>זריזות וכוח</Text>
        <View style={styles.table}>
          <View style={styles.tableHeader}>
            <Text style={styles.tableCellHeader}>תאריך</Text>
            <Text style={styles.tableCellHeader}>זמן Blaze</Text>
            <Text style={styles.tableCellHeader}>כוח בעיטה</Text>
          </View>
          {assessments.map((a) => (
            <View key={a.id} style={styles.tableRow}>
              <Text style={styles.tableCell}>{formatDate(a.assessment_date)}</Text>
              <Text style={styles.tableCell}>{a.blaze_spot_time ?? "---"}</Text>
              <Text style={styles.tableCell}>{a.kick_power_kaiser ?? "---"}</Text>
            </View>
          ))}
        </View>

        {/* Footer */}
        <Text style={styles.footer}>
          נוצר ב-{generatedAt} | Garden of Eden
        </Text>
      </Page>
    </Document>
  );
}
```

2. **src/components/admin/exports/AssessmentPdfButton.tsx** - Export button:

```tsx
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { FileText, Loader2 } from "lucide-react";
import { toast } from "sonner";
import type { PlayerAssessment } from "@/types/assessment";

interface AssessmentPdfButtonProps {
  playerName: string;
  assessments: PlayerAssessment[];
}

export function AssessmentPdfButton({
  playerName,
  assessments,
}: AssessmentPdfButtonProps) {
  const [loading, setLoading] = useState(false);

  const handleExport = async () => {
    if (assessments.length === 0) {
      toast.error("אין מבדקים לייצוא");
      return;
    }

    setLoading(true);
    try {
      // Dynamic import to avoid SSR issues
      const [{ pdf }, { AssessmentPdfDocument }] = await Promise.all([
        import("@react-pdf/renderer"),
        import("@/lib/exports/pdf-assessment-template"),
      ]);

      const generatedAt = new Date().toLocaleDateString("he-IL");
      const blob = await pdf(
        <AssessmentPdfDocument
          playerName={playerName}
          assessments={assessments}
          generatedAt={generatedAt}
        />
      ).toBlob();

      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `דוח-מבדקים-${playerName}-${new Date().toISOString().split("T")[0]}.pdf`;
      link.click();
      URL.revokeObjectURL(link.href);

      toast.success("הדוח יוצא בהצלחה");
    } catch (error) {
      console.error("PDF generation error:", error);
      toast.error("שגיאה ביצירת הדוח");
    } finally {
      setLoading(false);
    }
  };

  return (
    <Button
      onClick={handleExport}
      variant="outline"
      size="sm"
      disabled={assessments.length === 0 || loading}
    >
      {loading ? (
        <Loader2 className="h-4 w-4 ml-2 animate-spin" />
      ) : (
        <FileText className="h-4 w-4 ml-2" />
      )}
      {loading ? "מייצא..." : "ייצוא PDF"}
    </Button>
  );
}
```

Create directory: `mkdir -p src/lib/exports`
  </action>
  <verify>TypeScript compiles: `npm run build -- --no-emit 2>&1 | head -20`</verify>
  <done>PDF template and button created with RTL support and branding.</done>
</task>

<task type="auto">
  <name>Task 4: Add export buttons to assessment page</name>
  <files>src/app/admin/assessments/[userId]/page.tsx</files>
  <action>
Add both CSV and PDF export buttons to the assessment page header:

1. Import export components at the top:
```tsx
import { AssessmentExportButton } from "@/components/admin/exports/AssessmentExportButton";
import { AssessmentPdfButton } from "@/components/admin/exports/AssessmentPdfButton";
```

2. Find the header section that has the "מבדק חדש" button and add export buttons:

Current structure:
```tsx
<div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
  <div>
    <h1 className="text-2xl font-bold">{profile.full_name || "ללא שם"}</h1>
    ...
  </div>
  <Button asChild>
    <Link href={`/admin/assessments/${userId}/new`}>
      <Plus className="h-4 w-4 ml-2" />
      מבדק חדש
    </Link>
  </Button>
</div>
```

Change to include export buttons:
```tsx
<div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
  <div>
    <h1 className="text-2xl font-bold">{profile.full_name || "ללא שם"}</h1>
    ...
  </div>
  <div className="flex items-center gap-2">
    <AssessmentExportButton
      playerName={profile.full_name || "שחקן"}
      assessments={(assessments || []) as PlayerAssessment[]}
    />
    <AssessmentPdfButton
      playerName={profile.full_name || "שחקן"}
      assessments={(assessments || []) as PlayerAssessment[]}
    />
    <Button asChild>
      <Link href={`/admin/assessments/${userId}/new`}>
        <Plus className="h-4 w-4 ml-2" />
        מבדק חדש
      </Link>
    </Button>
  </div>
</div>
```
  </action>
  <verify>TypeScript compiles: `npm run build -- --no-emit 2>&1 | head -20`</verify>
  <done>Export buttons visible in assessment page header.</done>
</task>

</tasks>

<verification>
1. @react-pdf/renderer is installed
2. Font files exist in public/fonts/
3. Export components exist and compile
4. Assessment page shows CSV and PDF export buttons
</verification>

<success_criteria>
- CSV export downloads with Hebrew column headers
- PDF export generates branded document with RTL layout
- Both buttons show loading state during generation
- Error handling with toast notifications
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-export-assessments/04-04-SUMMARY.md`
</output>
