---
phase: 04-data-export-assessments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/YYYYMMDDHHMMSS_add_deleted_by_to_assessments.sql
  - src/types/database.ts
  - src/lib/actions/admin-assessments.ts
autonomous: true

must_haves:
  truths:
    - "Assessment soft delete updates deleted_at and deleted_by columns"
    - "Only admins can delete assessments"
    - "Deletion is logged to activity_logs"
  artifacts:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_add_deleted_by_to_assessments.sql"
      provides: "deleted_by UUID column for audit trail"
      contains: "deleted_by"
    - path: "src/lib/actions/admin-assessments.ts"
      provides: "softDeleteAssessmentAction server action"
      exports: ["softDeleteAssessmentAction"]
  key_links:
    - from: "src/lib/actions/admin-assessments.ts"
      to: "player_assessments table"
      via: "update with deleted_at and deleted_by"
      pattern: "deleted_at.*deleted_by"
---

<objective>
Add database column for audit trail and create server action for soft-deleting assessments.

Purpose: Enable assessment deletion with proper audit trail (who deleted and when).
Output: Migration file, updated types, and softDeleteAssessmentAction server action.
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-data-export-assessments/04-CONTEXT.md
@.planning/phases/04-data-export-assessments/04-RESEARCH.md

# Reference patterns:
@src/lib/actions/admin-users.ts (verifyAdmin helper, ActionResult pattern, soft delete pattern)
@src/types/database.ts (existing deleted_at on player_assessments)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for deleted_by column</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_add_deleted_by_to_assessments.sql</files>
  <action>
Create a SQL migration that:
1. Adds `deleted_by UUID REFERENCES auth.users(id)` column to `player_assessments` table
2. Add comment explaining the audit purpose

Use existing migration naming convention from `supabase/migrations/` directory. Get timestamp with `date -u +%Y%m%d%H%M%S`.

Migration content:
```sql
-- Add deleted_by column to player_assessments for audit trail
-- This tracks which admin deleted the assessment
ALTER TABLE player_assessments
ADD COLUMN deleted_by UUID REFERENCES auth.users(id);

COMMENT ON COLUMN player_assessments.deleted_by IS 'UUID of admin who soft-deleted this assessment';
```
  </action>
  <verify>File exists in supabase/migrations/ with correct SQL syntax.</verify>
  <done>Migration file created with deleted_by UUID column definition.</done>
</task>

<task type="auto">
  <name>Task 2: Update database types</name>
  <files>src/types/database.ts</files>
  <action>
Add `deleted_by: string | null` to the player_assessments Row, Insert, and Update types.

Find the `player_assessments` table definition in the Database interface and add the deleted_by field after deleted_at:
- Row: `deleted_by: string | null;`
- Insert: `deleted_by?: string | null;`
- Update: `deleted_by?: string | null;`

This mirrors the pattern used for `deleted_at` in the same table.
  </action>
  <verify>TypeScript compiles without errors: `npm run build -- --no-emit 2>&1 | head -20`</verify>
  <done>deleted_by field added to player_assessments types (Row, Insert, Update).</done>
</task>

<task type="auto">
  <name>Task 3: Create softDeleteAssessmentAction server action</name>
  <files>src/lib/actions/admin-assessments.ts</files>
  <action>
Create new file `src/lib/actions/admin-assessments.ts` with softDeleteAssessmentAction:

Follow the pattern from admin-users.ts exactly:
1. Import createClient, createAdminClient, revalidatePath
2. Create ActionResult type: `{ success: true } | { error: string }`
3. Create verifyAdmin helper (copy from admin-users.ts)
4. Create softDeleteAssessmentAction:
   - Accept assessmentId: string parameter
   - Call verifyAdmin() to check admin access
   - Validate assessmentId is UUID format using regex
   - Use adminClient to update player_assessments with deleted_at (new Date().toISOString()) and deleted_by (user.id)
   - Fetch the assessment's user_id before update for activity log
   - Log to activity_logs with action: "assessment_deleted", actor_id, actor_name, metadata: { assessment_id }
   - Call revalidatePath("/admin/assessments")
   - Return { success: true }

Use "use server" directive at top. Use try/catch for database errors.

Hebrew error messages:
- "לא מחובר" for not authenticated
- "נדרשת הרשאת מנהל" for non-admin
- "מזהה מבדק לא תקין" for invalid UUID
- "שגיאה במחיקת המבדק" for database errors
  </action>
  <verify>TypeScript compiles: `npm run build -- --no-emit 2>&1 | head -20`</verify>
  <done>softDeleteAssessmentAction exported and follows admin-users.ts patterns.</done>
</task>

</tasks>

<verification>
1. Migration file exists with correct SQL
2. TypeScript compiles without errors
3. softDeleteAssessmentAction is exported from admin-assessments.ts
</verification>

<success_criteria>
- deleted_by column migration created
- Database types updated with deleted_by field
- softDeleteAssessmentAction server action works (returns ActionResult)
- Follows established patterns from admin-users.ts
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-export-assessments/04-01-SUMMARY.md`
</output>
