---
phase: 02-user-management
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/admin/users/DeleteUserDialog.tsx
  - src/app/admin/users/[userId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Delete button exists on user profile page"
    - "Delete confirmation dialog shows user name and warning"
    - "Delete calls softDeleteUserAction server action"
    - "Success shows toast and redirects to /admin/users"
    - "Admin cannot delete their own account"
  artifacts:
    - path: "src/components/admin/users/DeleteUserDialog.tsx"
      provides: "Confirmation dialog for soft-deleting users"
      exports: ["DeleteUserDialog"]
  key_links:
    - from: "src/components/admin/users/DeleteUserDialog.tsx"
      to: "src/lib/actions/admin-users.ts"
      via: "softDeleteUserAction import"
      pattern: "import.*softDeleteUserAction.*from.*@/lib/actions/admin-users"
---

<objective>
Create the delete user dialog and integrate it into the user profile page.

Purpose: Enable admins to soft-delete users with proper confirmation and feedback.

Output:
- DeleteUserDialog component with confirmation
- Integration into existing user profile page
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-user-management/02-CONTEXT.md
@.planning/phases/02-user-management/02-01-SUMMARY.md

Key existing files:
@src/app/admin/users/[userId]/page.tsx - existing user profile page to update
@src/lib/actions/admin-users.ts - softDeleteUserAction from Plan 01
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DeleteUserDialog component</name>
  <files>src/components/admin/users/DeleteUserDialog.tsx</files>
  <action>
Create confirmation dialog for soft-deleting users.

Props:
- user: Profile (to display name and check if self-deletion)
- currentUserId: string (to prevent self-deletion)
- trigger?: React.ReactNode (optional custom trigger)

Features:
- Uses shadcn/ui AlertDialog
- Shows warning about soft delete (data preserved)
- Displays user name being deleted
- Prevents self-deletion (disable button with tooltip)
- Loading state during deletion
- Calls softDeleteUserAction on confirm
- Shows toast on success/error
- Redirects to /admin/users on success

```typescript
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { Loader2, Trash2 } from "lucide-react";
import { softDeleteUserAction } from "@/lib/actions/admin-users";
import type { Profile } from "@/types/database";

interface DeleteUserDialogProps {
  user: Profile;
  currentUserId: string;
  trigger?: React.ReactNode;
}

export function DeleteUserDialog({ user, currentUserId, trigger }: DeleteUserDialogProps) {
  const [open, setOpen] = useState(false);
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  const isSelf = user.id === currentUserId;

  const handleDelete = async () => {
    if (isSelf) {
      toast.error("לא ניתן למחוק את החשבון שלך");
      return;
    }

    setLoading(true);
    try {
      const result = await softDeleteUserAction(user.id);

      if (result.error) {
        toast.error(result.error);
        return;
      }

      toast.success("המשתמש נמחק בהצלחה");
      setOpen(false);
      router.push("/admin/users");
      router.refresh();
    } catch (error) {
      toast.error("שגיאה במחיקת המשתמש");
    } finally {
      setLoading(false);
    }
  };

  return (
    <AlertDialog open={open} onOpenChange={setOpen}>
      <AlertDialogTrigger asChild>
        {trigger || (
          <Button variant="destructive" disabled={isSelf}>
            <Trash2 className="h-4 w-4 ml-2" />
            מחיקת משתמש
          </Button>
        )}
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>מחיקת משתמש</AlertDialogTitle>
          <AlertDialogDescription className="space-y-2">
            <p>האם אתה בטוח שברצונך למחוק את המשתמש <strong>{user.full_name}</strong>?</p>
            <p className="text-muted-foreground">
              המשתמש יסומן כמחוק אך הנתונים ישמרו במערכת.
              ניתן יהיה לשחזר את המשתמש בעתיד.
            </p>
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel disabled={loading}>ביטול</AlertDialogCancel>
          <AlertDialogAction
            onClick={(e) => {
              e.preventDefault();
              handleDelete();
            }}
            disabled={loading || isSelf}
            className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
          >
            {loading ? (
              <>
                <Loader2 className="h-4 w-4 ml-2 animate-spin" />
                מוחק...
              </>
            ) : (
              "מחק משתמש"
            )}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Component imports softDeleteUserAction from Plan 01.
  </verify>
  <done>DeleteUserDialog component created with confirmation and loading state</done>
</task>

<task type="auto">
  <name>Task 2: Integrate delete dialog into user profile page</name>
  <files>src/app/admin/users/[userId]/page.tsx</files>
  <action>
Update existing user profile page to include delete functionality.

Changes needed:
1. Import DeleteUserDialog component
2. Add delete button in page actions area
3. Pass current user ID to dialog for self-deletion check
4. Add "Reset Credentials" button (calls resetUserCredentialsAction)

Read existing page first to understand structure, then add:
- Delete button (using DeleteUserDialog)
- Reset credentials button (direct action call with toast feedback)

Both buttons should be in a card or section below the edit form.

Example integration:
```typescript
// In the page component, after the edit form card
<Card>
  <CardHeader>
    <CardTitle>פעולות נוספות</CardTitle>
  </CardHeader>
  <CardContent className="flex gap-4">
    <Button
      variant="outline"
      onClick={handleResetCredentials}
      disabled={resetLoading}
    >
      {resetLoading ? <Loader2 className="h-4 w-4 ml-2 animate-spin" /> : <KeyRound className="h-4 w-4 ml-2" />}
      איפוס סיסמה
    </Button>

    <DeleteUserDialog
      user={user}
      currentUserId={currentUser.id}
    />
  </CardContent>
</Card>
```

Note: The reset credentials action may need a client component wrapper since the page is a server component. Either:
- Create a small client wrapper component for the buttons
- Or move the entire actions section to a client component
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Delete button visible on user profile page.
Reset credentials button visible.
Build passes: `npm run build`
  </verify>
  <done>User profile page has delete and reset credentials buttons integrated</done>
</task>

</tasks>

<verification>
1. TypeScript passes: `npx tsc --noEmit`
2. Build passes: `npm run build`
3. Delete dialog shows confirmation with user name
4. Self-deletion is prevented
5. Reset credentials button exists
</verification>

<success_criteria>
- Delete button visible on user profile page
- Confirmation dialog shows user name and warning
- Delete calls soft delete (not hard delete)
- Self-deletion is blocked with appropriate message
- Reset credentials button triggers appropriate action
- Success shows toast and redirects
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-04-SUMMARY.md`
</output>
