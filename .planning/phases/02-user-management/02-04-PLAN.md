---
phase: 02-user-management
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/admin/users/DeleteUserDialog.tsx
  - src/components/admin/users/UserActionsCard.tsx
  - src/app/admin/users/[userId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Delete button exists on user profile page"
    - "Delete confirmation dialog shows user name and warning"
    - "Delete calls softDeleteUserAction server action"
    - "Success shows toast and redirects to /admin/users"
    - "Admin cannot delete their own account"
    - "Reset credentials button triggers password reset email"
    - "Reset credentials shows loading state and toast feedback"
  artifacts:
    - path: "src/components/admin/users/DeleteUserDialog.tsx"
      provides: "Confirmation dialog for soft-deleting users"
      exports: ["DeleteUserDialog"]
    - path: "src/components/admin/users/UserActionsCard.tsx"
      provides: "Client component wrapping delete and reset actions"
      exports: ["UserActionsCard"]
  key_links:
    - from: "src/components/admin/users/DeleteUserDialog.tsx"
      to: "src/lib/actions/admin-users.ts"
      via: "softDeleteUserAction import"
      pattern: "import.*softDeleteUserAction.*from.*@/lib/actions/admin-users"
    - from: "src/components/admin/users/UserActionsCard.tsx"
      to: "src/lib/actions/admin-users.ts"
      via: "resetUserCredentialsAction import"
      pattern: "import.*resetUserCredentialsAction.*from.*@/lib/actions/admin-users"
---

<objective>
Create the delete user dialog, user actions card, and integrate into the user profile page.

Purpose: Enable admins to soft-delete users and reset credentials with proper confirmation and feedback.

Output:
- DeleteUserDialog component with confirmation
- UserActionsCard client component (wraps delete and reset credentials)
- Integration into existing user profile page
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-user-management/02-CONTEXT.md
@.planning/phases/02-user-management/02-01-SUMMARY.md

Key existing files:
@src/app/admin/users/[userId]/page.tsx - existing user profile page to update
@src/lib/actions/admin-users.ts - softDeleteUserAction from Plan 01
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DeleteUserDialog component</name>
  <files>src/components/admin/users/DeleteUserDialog.tsx</files>
  <action>
Create confirmation dialog for soft-deleting users.

Props:
- user: Profile (to display name and check if self-deletion)
- currentUserId: string (to prevent self-deletion)
- trigger?: React.ReactNode (optional custom trigger)

Features:
- Uses shadcn/ui AlertDialog
- Shows warning about soft delete (data preserved)
- Displays user name being deleted
- Prevents self-deletion (disable button with tooltip)
- Loading state during deletion
- Calls softDeleteUserAction on confirm
- Shows toast on success/error
- Redirects to /admin/users on success

```typescript
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { Loader2, Trash2 } from "lucide-react";
import { softDeleteUserAction } from "@/lib/actions/admin-users";
import type { Profile } from "@/types/database";

interface DeleteUserDialogProps {
  user: Profile;
  currentUserId: string;
  trigger?: React.ReactNode;
}

export function DeleteUserDialog({ user, currentUserId, trigger }: DeleteUserDialogProps) {
  const [open, setOpen] = useState(false);
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  const isSelf = user.id === currentUserId;

  const handleDelete = async () => {
    if (isSelf) {
      toast.error("לא ניתן למחוק את החשבון שלך");
      return;
    }

    setLoading(true);
    try {
      const result = await softDeleteUserAction(user.id);

      if (result.error) {
        toast.error(result.error);
        return;
      }

      toast.success("המשתמש נמחק בהצלחה");
      setOpen(false);
      router.push("/admin/users");
      router.refresh();
    } catch (error) {
      toast.error("שגיאה במחיקת המשתמש");
    } finally {
      setLoading(false);
    }
  };

  return (
    <AlertDialog open={open} onOpenChange={setOpen}>
      <AlertDialogTrigger asChild>
        {trigger || (
          <Button variant="destructive" disabled={isSelf}>
            <Trash2 className="h-4 w-4 ml-2" />
            מחיקת משתמש
          </Button>
        )}
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>מחיקת משתמש</AlertDialogTitle>
          <AlertDialogDescription className="space-y-2">
            <p>האם אתה בטוח שברצונך למחוק את המשתמש <strong>{user.full_name}</strong>?</p>
            <p className="text-muted-foreground">
              המשתמש יסומן כמחוק אך הנתונים ישמרו במערכת.
              ניתן יהיה לשחזר את המשתמש בעתיד.
            </p>
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel disabled={loading}>ביטול</AlertDialogCancel>
          <AlertDialogAction
            onClick={(e) => {
              e.preventDefault();
              handleDelete();
            }}
            disabled={loading || isSelf}
            className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
          >
            {loading ? (
              <>
                <Loader2 className="h-4 w-4 ml-2 animate-spin" />
                מוחק...
              </>
            ) : (
              "מחק משתמש"
            )}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Component imports softDeleteUserAction from Plan 01.
  </verify>
  <done>DeleteUserDialog component created with confirmation and loading state</done>
</task>

<task type="auto">
  <name>Task 2: Create UserActionsCard client component</name>
  <files>src/components/admin/users/UserActionsCard.tsx</files>
  <action>
Create a client component that wraps both delete and reset credentials actions.

This component solves the server/client boundary issue: the user profile page is a server component, but reset credentials needs client-side state (loading, onClick handlers). By creating this wrapper, we keep the page as a server component while having proper client interactivity.

Props:
- user: Profile (the user being managed)
- currentUserId: string (to prevent self-deletion)

```typescript
"use client";

import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { Loader2, KeyRound } from "lucide-react";
import { resetUserCredentialsAction } from "@/lib/actions/admin-users";
import { DeleteUserDialog } from "./DeleteUserDialog";
import type { Profile } from "@/types/database";

interface UserActionsCardProps {
  user: Profile;
  currentUserId: string;
}

export function UserActionsCard({ user, currentUserId }: UserActionsCardProps) {
  const [resetLoading, setResetLoading] = useState(false);

  const handleResetCredentials = async () => {
    setResetLoading(true);
    try {
      const result = await resetUserCredentialsAction(user.id);

      if (result.error) {
        toast.error(result.error);
        return;
      }

      toast.success("נשלח אימייל לאיפוס סיסמה");
    } catch (error) {
      toast.error("שגיאה באיפוס הסיסמה");
    } finally {
      setResetLoading(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>פעולות נוספות</CardTitle>
      </CardHeader>
      <CardContent className="flex gap-4">
        <Button
          variant="outline"
          onClick={handleResetCredentials}
          disabled={resetLoading}
        >
          {resetLoading ? (
            <Loader2 className="h-4 w-4 ml-2 animate-spin" />
          ) : (
            <KeyRound className="h-4 w-4 ml-2" />
          )}
          איפוס סיסמה
        </Button>

        <DeleteUserDialog
          user={user}
          currentUserId={currentUserId}
        />
      </CardContent>
    </Card>
  );
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Component exports UserActionsCard.
  </verify>
  <done>UserActionsCard client component wraps reset credentials with state and DeleteUserDialog</done>
</task>

<task type="auto">
  <name>Task 3: Integrate UserActionsCard into user profile page</name>
  <files>src/app/admin/users/[userId]/page.tsx</files>
  <action>
Update existing user profile page to include the UserActionsCard component.

Changes needed:
1. Import UserActionsCard component
2. Add UserActionsCard below the edit form card
3. Pass user and currentUserId props

Read existing page first to understand structure. The page should remain a server component - all client interactivity is encapsulated in UserActionsCard.

Example integration (add after the edit form card):
```typescript
import { UserActionsCard } from "@/components/admin/users/UserActionsCard";

// ... in the JSX, after the edit form card:
<UserActionsCard
  user={user}
  currentUserId={currentUser.id}
/>
```

This keeps the server component clean while delegating client-side state management to UserActionsCard.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
UserActionsCard visible on user profile page.
Build passes: `npm run build`
  </verify>
  <done>User profile page integrates UserActionsCard with delete and reset credentials actions</done>
</task>

</tasks>

<verification>
1. TypeScript passes: `npx tsc --noEmit`
2. Build passes: `npm run build`
3. Delete dialog shows confirmation with user name
4. Self-deletion is prevented
5. Reset credentials button exists
</verification>

<success_criteria>
- Delete button visible on user profile page
- Confirmation dialog shows user name and warning
- Delete calls soft delete (not hard delete)
- Self-deletion is blocked with appropriate message
- Reset credentials button with loading state and toast feedback
- UserActionsCard encapsulates all client-side state
- Success shows toast and redirects (for delete)
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-04-SUMMARY.md`
</output>
