---
phase: 02-user-management
plan: 07
type: execute
wave: 5
depends_on: ["02-06"]
files_modified:
  - src/lib/actions/__tests__/admin-users.test.ts
  - src/lib/validations/__tests__/user-create.test.ts
  - src/lib/validations/__tests__/user-import.test.ts
autonomous: true

must_haves:
  truths:
    - "Tests exist for user creation validation"
    - "Tests exist for CSV import validation"
    - "Tests verify soft delete sets deleted_at"
    - "Tests verify admin role is checked in actions"
  artifacts:
    - path: "src/lib/validations/__tests__/user-create.test.ts"
      provides: "Tests for user creation validation schema"
      min_lines: 30
    - path: "src/lib/validations/__tests__/user-import.test.ts"
      provides: "Tests for CSV import validation schema"
      min_lines: 30
    - path: "src/lib/actions/__tests__/admin-users.test.ts"
      provides: "Tests for admin user server actions"
      min_lines: 50
  key_links:
    - from: "src/lib/validations/__tests__/user-create.test.ts"
      to: "src/lib/validations/user-create.ts"
      via: "schema import"
      pattern: "import.*userCreateSchema.*from.*@/lib/validations/user-create"
---

<objective>
Write tests for Phase 2 user management functionality.

Purpose: Ensure user creation, soft delete, and CSV import work correctly with validation.

Output:
- Validation schema tests (user creation, CSV import)
- Server action tests (admin role verification, soft delete)
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-user-management/02-01-SUMMARY.md

Key files:
@src/lib/validations/__tests__/payment.test.ts - existing test patterns
@src/lib/validations/__tests__/webhook.test.ts - existing test patterns
@src/lib/validations/user-create.ts - schema to test
@src/lib/validations/user-import.ts - schema to test
@src/lib/actions/admin-users.ts - actions to test
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user creation validation tests</name>
  <files>src/lib/validations/__tests__/user-create.test.ts</files>
  <action>
Create tests for userCreateSchema following existing test patterns.

Test cases:
1. Valid data passes validation
   - Full name, phone (0XX format), role
   - Full name, phone (+972 format), role, email
2. Invalid data fails with appropriate errors
   - Name too short (< 2 chars)
   - Name too long (> 100 chars)
   - Invalid phone format
   - Invalid role value
   - Invalid email format
3. Edge cases
   - Empty email is allowed
   - Phone with leading zero
   - Phone with +972 prefix

```typescript
import { describe, it, expect } from "vitest";
import { userCreateSchema } from "../user-create";

describe("userCreateSchema", () => {
  describe("valid data", () => {
    it("should accept valid name, phone, and role", () => {
      const result = userCreateSchema.safeParse({
        full_name: "יוסי כהן",
        phone: "0501234567",
        role: "trainee",
      });
      expect(result.success).toBe(true);
    });

    it("should accept +972 phone format", () => {
      const result = userCreateSchema.safeParse({
        full_name: "יוסי כהן",
        phone: "+972501234567",
        role: "trainer",
      });
      expect(result.success).toBe(true);
    });

    it("should accept optional email", () => {
      const result = userCreateSchema.safeParse({
        full_name: "יוסי כהן",
        phone: "0501234567",
        role: "admin",
        email: "test@example.com",
      });
      expect(result.success).toBe(true);
    });

    it("should accept empty email", () => {
      const result = userCreateSchema.safeParse({
        full_name: "יוסי כהן",
        phone: "0501234567",
        role: "trainee",
        email: "",
      });
      expect(result.success).toBe(true);
    });
  });

  describe("invalid data", () => {
    it("should reject name shorter than 2 characters", () => {
      const result = userCreateSchema.safeParse({
        full_name: "י",
        phone: "0501234567",
        role: "trainee",
      });
      expect(result.success).toBe(false);
    });

    it("should reject invalid phone format", () => {
      const result = userCreateSchema.safeParse({
        full_name: "יוסי כהן",
        phone: "12345",
        role: "trainee",
      });
      expect(result.success).toBe(false);
    });

    it("should reject invalid role", () => {
      const result = userCreateSchema.safeParse({
        full_name: "יוסי כהן",
        phone: "0501234567",
        role: "superadmin",
      });
      expect(result.success).toBe(false);
    });

    it("should reject invalid email", () => {
      const result = userCreateSchema.safeParse({
        full_name: "יוסי כהן",
        phone: "0501234567",
        role: "trainee",
        email: "not-an-email",
      });
      expect(result.success).toBe(false);
    });
  });
});
```
  </action>
  <verify>
Run tests: `npm test -- src/lib/validations/__tests__/user-create.test.ts`
All tests pass.
  </verify>
  <done>User creation validation tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Create CSV import validation tests</name>
  <files>src/lib/validations/__tests__/user-import.test.ts</files>
  <action>
Create tests for csvRowSchema.

Test cases:
1. Valid CSV rows
   - All required fields present
   - Role defaults to trainee when missing
   - Empty email transforms to undefined
2. Invalid CSV rows
   - Missing name
   - Invalid phone
   - Invalid role
3. Edge cases
   - Hebrew column name mapping (tested via component, but schema handles data)

```typescript
import { describe, it, expect } from "vitest";
import { csvRowSchema } from "../user-import";

describe("csvRowSchema", () => {
  describe("valid rows", () => {
    it("should accept valid row with all fields", () => {
      const result = csvRowSchema.safeParse({
        name: "יוסי כהן",
        phone: "0501234567",
        role: "trainee",
        email: "test@example.com",
      });
      expect(result.success).toBe(true);
      expect(result.data).toEqual({
        name: "יוסי כהן",
        phone: "0501234567",
        role: "trainee",
        email: "test@example.com",
      });
    });

    it("should default role to trainee", () => {
      const result = csvRowSchema.safeParse({
        name: "יוסי כהן",
        phone: "0501234567",
      });
      expect(result.success).toBe(true);
      expect(result.data?.role).toBe("trainee");
    });

    it("should transform empty email to undefined", () => {
      const result = csvRowSchema.safeParse({
        name: "יוסי כהן",
        phone: "0501234567",
        role: "trainer",
        email: "",
      });
      expect(result.success).toBe(true);
      expect(result.data?.email).toBeUndefined();
    });
  });

  describe("invalid rows", () => {
    it("should reject missing name", () => {
      const result = csvRowSchema.safeParse({
        phone: "0501234567",
        role: "trainee",
      });
      expect(result.success).toBe(false);
    });

    it("should reject invalid phone", () => {
      const result = csvRowSchema.safeParse({
        name: "יוסי כהן",
        phone: "invalid",
        role: "trainee",
      });
      expect(result.success).toBe(false);
    });

    it("should reject invalid role value", () => {
      const result = csvRowSchema.safeParse({
        name: "יוסי כהן",
        phone: "0501234567",
        role: "invalid_role",
      });
      expect(result.success).toBe(false);
    });
  });
});
```
  </action>
  <verify>
Run tests: `npm test -- src/lib/validations/__tests__/user-import.test.ts`
All tests pass.
  </verify>
  <done>CSV import validation tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Create server action tests</name>
  <files>src/lib/actions/__tests__/admin-users.test.ts</files>
  <action>
Create tests for admin user server actions. Since actions depend on Supabase, focus on testing the validation and error handling logic that can be tested without mocking the full Supabase client.

For now, create placeholder tests that document expected behavior. Full integration tests would require Supabase test setup.

```typescript
import { describe, it, expect, vi } from "vitest";

// Note: These tests document expected behavior. Full integration tests
// require Supabase test setup which is Phase 9 scope.

describe("admin-users server actions", () => {
  describe("createUserAction", () => {
    it.todo("should reject if user is not authenticated");
    it.todo("should reject if user is not admin");
    it.todo("should validate input with userCreateSchema");
    it.todo("should format phone to +972 format");
    it.todo("should create user via auth.admin.createUser");
    it.todo("should update profile with role");
    it.todo("should log activity after creation");
    it.todo("should handle already registered phone error");
  });

  describe("softDeleteUserAction", () => {
    it.todo("should reject if user is not authenticated");
    it.todo("should reject if user is not admin");
    it.todo("should prevent self-deletion");
    it.todo("should set deleted_at timestamp");
    it.todo("should NOT hard delete the user");
    it.todo("should log activity after deletion");
  });

  describe("resetUserCredentialsAction", () => {
    it.todo("should reject if user is not authenticated");
    it.todo("should reject if user is not admin");
    it.todo("should get target user info");
    it.todo("should generate magic link for user");
    it.todo("should log activity after reset");
  });

  describe("bulkCreateUsersAction", () => {
    it.todo("should reject if user is not admin");
    it.todo("should create multiple users");
    it.todo("should continue on individual user errors");
    it.todo("should return count of created and errors");
    it.todo("should log bulk activity");
  });
});
```

Note: Server actions are tested via the human verification checkpoint in Plan 06.
Full automated integration tests will be added in Phase 9 (Testing & Quality).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Test file exists and documents expected behavior.
  </verify>
  <done>Server action test file created with documented expected behaviors</done>
</task>

</tasks>

<verification>
1. TypeScript passes: `npx tsc --noEmit`
2. Validation tests pass: `npm test -- src/lib/validations/__tests__/user-create.test.ts src/lib/validations/__tests__/user-import.test.ts`
3. Test patterns match existing test structure
4. Server action tests document expected behavior
</verification>

<success_criteria>
- User creation schema tests pass
- CSV import schema tests pass
- Server action tests document expected behavior
- All tests run without errors
- Build passes: `npm run build`
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-07-SUMMARY.md`
</output>
