---
phase: 02-user-management
plan: 06
type: execute
wave: 4
depends_on: ["02-02", "02-03", "02-04", "02-05"]
files_modified:
  - src/app/admin/users/page.tsx
autonomous: false

must_haves:
  truths:
    - "Users page integrates all components (table, toolbar, import/export)"
    - "Create User button in toolbar links to creation page"
    - "Import and Export buttons visible in toolbar"
    - "All components work together without errors"
  artifacts:
    - path: "src/app/admin/users/page.tsx"
      provides: "Complete admin users page with all features"
      min_lines: 80
  key_links:
    - from: "src/app/admin/users/page.tsx"
      to: "src/components/admin/users/UserDataTable.tsx"
      via: "UserDataTable import"
      pattern: "import.*UserDataTable.*from.*@/components/admin/users"
---

<objective>
Integrate all user management components into the admin users page.

Purpose: Bring together the data table, toolbar, import/export, and all functionality into a cohesive admin user management experience.

Output:
- Complete refactored admin users page
- Visual verification checkpoint
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-user-management/02-CONTEXT.md
@.planning/phases/02-user-management/02-01-SUMMARY.md
@.planning/phases/02-user-management/02-02-SUMMARY.md
@.planning/phases/02-user-management/02-03-SUMMARY.md
@.planning/phases/02-user-management/02-04-SUMMARY.md
@.planning/phases/02-user-management/02-05-SUMMARY.md

All components created in previous plans.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate all components into admin users page</name>
  <files>src/app/admin/users/page.tsx</files>
  <action>
Refactor the admin users page to use all new components.

The page should:
1. Remain a server component for data fetching
2. Fetch all users from Supabase (including soft-deleted for admin filter)
3. Read URL search params for initial filter state
4. Pass data and initial state to UserDataTable
5. Include UserImportDialog and UserExportButton in the toolbar area

Structure:
```typescript
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Users } from "lucide-react";
import { UserDataTable } from "@/components/admin/users/UserDataTable";
import { UserImportDialog } from "@/components/admin/users/UserImportDialog";
import { UserExportButton } from "@/components/admin/users/UserExportButton";
import type { Profile } from "@/types/database";

interface PageProps {
  searchParams: Promise<{
    q?: string;
    role?: string;
    status?: string;
    deleted?: string;
  }>;
}

export default async function AdminUsersPage({ searchParams }: PageProps) {
  const supabase = await createClient();

  // Verify admin role
  const { data: { user: currentUser } } = await supabase.auth.getUser();
  if (!currentUser) redirect("/login");

  const { data: currentProfile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", currentUser.id)
    .single();

  if (currentProfile?.role !== "admin") redirect("/dashboard");

  // Fetch ALL users (including deleted for admin filtering)
  const { data: users, error } = await supabase
    .from("profiles")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Failed to fetch users:", error);
  }

  const typedUsers = (users || []) as Profile[];
  const params = await searchParams;

  return (
    <div className="space-y-8">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold mb-2">ניהול משתמשים</h1>
          <p className="text-muted-foreground">
            צפייה וניהול של כל המשתמשים במערכת
          </p>
        </div>
        <div className="flex items-center gap-2">
          <UserImportDialog />
          <UserExportButton users={typedUsers.filter(u => !u.deleted_at)} />
        </div>
      </div>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Users className="h-5 w-5" />
            רשימת משתמשים ({typedUsers.filter(u => !u.deleted_at).length})
          </CardTitle>
          <CardDescription>כל המשתמשים הרשומים במערכת</CardDescription>
        </CardHeader>
        <CardContent>
          <UserDataTable
            data={typedUsers}
            initialSearch={params.q || ""}
            initialRole={params.role || null}
            initialStatus={params.status || null}
            initialShowDeleted={params.deleted === "true"}
          />
        </CardContent>
      </Card>
    </div>
  );
}
```

Notes:
- Export button gets non-deleted users for export (filtered view)
- User count shows non-deleted count
- All filter state read from URL params
- Import/Export buttons in header area
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Build passes: `npm run build`
Page renders without errors.
  </verify>
  <done>Admin users page integrates all components: data table, import, export</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete admin user management system:
- Data table with search, filter, sort, pagination
- User creation form at /admin/users/create
- Delete user confirmation dialog on user profile page
- CSV import dialog for bulk user creation
- CSV export button for reporting
  </what-built>
  <how-to-verify>
1. Navigate to /admin/users as an admin user
2. Verify the data table shows with columns: Avatar, Name, Phone, Role, Status
3. Test search: Type a name - should filter in real-time (after short delay)
4. Test filters: Select a Role from dropdown - should filter list
5. Test pagination: If more than 10 users, verify page navigation works
6. Click "Create User" button - should navigate to /admin/users/create
7. On create page, fill form with test data and submit
8. Verify new user appears in list after creation
9. Click on a user row - should navigate to user profile
10. On profile page, verify Delete button shows confirmation dialog
11. Test CSV Export: Click export button - should download CSV file
12. Test CSV Import: Click import, select a CSV file with format:
    ```csv
    name,phone,role,email
    Test User,0501234567,trainee,test@example.com
    ```
13. Verify import validates and shows preview before importing
  </how-to-verify>
  <resume-signal>Type "approved" if all features work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript passes: `npx tsc --noEmit`
2. Build passes: `npm run build`
3. All imports resolve correctly
4. Page renders with all components integrated
5. Human verification confirms all features work
</verification>

<success_criteria>
- Admin users page loads with all components
- Search filters users as you type
- Role and Status filters work
- Pagination navigates correctly
- Create User button links to creation page
- Row click navigates to user profile
- Import and Export buttons functional
- All features verified by human testing
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-06-SUMMARY.md`
</output>
