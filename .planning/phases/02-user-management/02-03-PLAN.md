---
phase: 02-user-management
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/admin/users/UserDataTable.tsx
  - src/components/admin/users/UserTableColumns.tsx
  - src/components/admin/users/UserTableToolbar.tsx
  - src/components/admin/users/UserTablePagination.tsx
autonomous: true

must_haves:
  truths:
    - "User list displays in TanStack Table with sortable columns"
    - "Search filters users as you type (debounced)"
    - "Role and Status filters work via URL state"
    - "Pagination shows 10 users per page with navigation"
    - "Create User button links to /admin/users/create"
    - "Row click navigates to user profile page"
    - "Deleted users hidden by default (filterable)"
  artifacts:
    - path: "src/components/admin/users/UserDataTable.tsx"
      provides: "TanStack Table wrapper component"
      exports: ["UserDataTable"]
    - path: "src/components/admin/users/UserTableColumns.tsx"
      provides: "Column definitions for user table"
      exports: ["columns"]
    - path: "src/components/admin/users/UserTableToolbar.tsx"
      provides: "Search and filter toolbar"
      exports: ["UserTableToolbar"]
    - path: "src/components/admin/users/UserTablePagination.tsx"
      provides: "Pagination controls"
      exports: ["UserTablePagination"]
  key_links:
    - from: "src/components/admin/users/UserDataTable.tsx"
      to: "@tanstack/react-table"
      via: "useReactTable hook"
      pattern: "import.*useReactTable.*from.*@tanstack/react-table"
    - from: "src/components/admin/users/UserTableToolbar.tsx"
      to: "nuqs"
      via: "useQueryState for URL state"
      pattern: "import.*useQueryState.*from.*nuqs"
---

<objective>
Build the data table components for the admin users list with search, filter, and pagination.

Purpose: Create reusable TanStack Table components supporting real-time search, filters persisted in URL, and paginated navigation. Page integration happens in Plan 02-06.

Output:
- Reusable table components (columns, toolbar, pagination, data table wrapper)
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-user-management/02-CONTEXT.md
@.planning/phases/02-user-management/02-RESEARCH.md
@.planning/phases/02-user-management/02-01-SUMMARY.md

Key existing files:
@src/app/admin/users/page.tsx - existing simple table to refactor
@src/types/database.ts - Profile type definition
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create table column definitions</name>
  <files>src/components/admin/users/UserTableColumns.tsx</files>
  <action>
Create column definitions for TanStack Table.

Columns per CONTEXT.md:
1. Avatar (if available, else initials/placeholder)
2. Name (full_name, sortable)
3. Phone (formatted, dir="ltr")
4. Role (badge with color: admin=red, trainer=blue, trainee=secondary)
5. Status (is_active badge: green/red)
6. Payment Status (placeholder for now - will integrate later)

Column definitions structure:
```typescript
"use client";

import { ColumnDef } from "@tanstack/react-table";
import { Badge } from "@/components/ui/badge";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { ArrowUpDown } from "lucide-react";
import { Button } from "@/components/ui/button";
import type { Profile } from "@/types/database";

// Helper to format phone
function formatPhone(phone: string | null): string {
  if (!phone) return "-";
  if (phone.startsWith("+972")) {
    return "0" + phone.slice(4);
  }
  return phone;
}

// Helper to get initials
function getInitials(name: string | null): string {
  if (!name) return "?";
  return name.split(" ").map(n => n[0]).join("").slice(0, 2).toUpperCase();
}

export const columns: ColumnDef<Profile>[] = [
  {
    id: "avatar",
    header: "",
    cell: ({ row }) => (
      <Avatar className="h-8 w-8">
        <AvatarImage src={row.original.avatar_url || undefined} />
        <AvatarFallback>{getInitials(row.original.full_name)}</AvatarFallback>
      </Avatar>
    ),
    enableSorting: false,
  },
  {
    accessorKey: "full_name",
    header: ({ column }) => (
      <Button variant="ghost" onClick={() => column.toggleSorting(column.getIsSorted() === "asc")}>
        שם
        <ArrowUpDown className="mr-2 h-4 w-4" />
      </Button>
    ),
    cell: ({ row }) => row.getValue("full_name") || "לא צוין",
  },
  // ... more columns for phone, role, status
];
```

Note: Row click to navigate is handled at table level, not column level.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Columns array exports correctly.
  </verify>
  <done>Column definitions created with Avatar, Name, Phone, Role, Status columns</done>
</task>

<task type="auto">
  <name>Task 2: Create table toolbar with search and filters</name>
  <files>src/components/admin/users/UserTableToolbar.tsx</files>
  <action>
Create toolbar component with search and filter dropdowns.

Features:
- Search input (debounced 300ms, updates URL via nuqs)
- Role filter dropdown (All, Admin, Trainer, Trainee)
- Status filter dropdown (All, Active, Inactive)
- Show deleted toggle (checkbox, hidden by default)
- Create User button (links to /admin/users/create)

URL state management with nuqs:
```typescript
"use client";

import { useQueryState, parseAsString, parseAsBoolean } from "nuqs";
import { useDebouncedCallback } from "use-debounce";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { UserPlus, Search } from "lucide-react";
import Link from "next/link";

interface UserTableToolbarProps {
  onSearchChange: (value: string) => void;
  onRoleChange: (value: string | null) => void;
  onStatusChange: (value: string | null) => void;
  onShowDeletedChange: (value: boolean) => void;
}

export function UserTableToolbar({
  onSearchChange,
  onRoleChange,
  onStatusChange,
  onShowDeletedChange,
}: UserTableToolbarProps) {
  const [search, setSearch] = useQueryState("q", parseAsString.withDefault(""));
  const [role, setRole] = useQueryState("role", parseAsString);
  const [status, setStatus] = useQueryState("status", parseAsString);
  const [showDeleted, setShowDeleted] = useQueryState("deleted", parseAsBoolean.withDefault(false));

  const debouncedSearch = useDebouncedCallback((value: string) => {
    setSearch(value || null);
    onSearchChange(value);
  }, 300);

  // ... render search input, dropdowns, create button
}
```

Layout: Inline row with search on left, filters in middle, create button on right.
All in Hebrew (חיפוש, תפקיד, סטטוס, הצג מחוקים, יצירת משתמש).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Search debounces and updates URL.
Filters update URL state.
  </verify>
  <done>Toolbar with search, role filter, status filter, show deleted toggle, create button</done>
</task>

<task type="auto">
  <name>Task 3: Create pagination component and data table wrapper</name>
  <files>src/components/admin/users/UserTablePagination.tsx, src/components/admin/users/UserDataTable.tsx</files>
  <action>
**Note:** This task creates the reusable table components. Integration into `src/app/admin/users/page.tsx` happens in Plan 02-06, which depends on this plan completing first.

**UserTablePagination.tsx:**
Pagination controls for the table.
- Previous/Next buttons
- Page X of Y display
- Page size selector (10, 20, 50)

```typescript
"use client";

import { Table } from "@tanstack/react-table";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { ChevronRight, ChevronLeft } from "lucide-react";

interface UserTablePaginationProps<TData> {
  table: Table<TData>;
}

export function UserTablePagination<TData>({ table }: UserTablePaginationProps<TData>) {
  return (
    <div className="flex items-center justify-between px-2 py-4">
      <div className="flex items-center gap-2">
        <span className="text-sm text-muted-foreground">שורות בעמוד</span>
        <Select
          value={String(table.getState().pagination.pageSize)}
          onValueChange={(value) => table.setPageSize(Number(value))}
        >
          <SelectTrigger className="w-[70px]">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            {[10, 20, 50].map((size) => (
              <SelectItem key={size} value={String(size)}>{size}</SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
      <div className="flex items-center gap-2">
        <span className="text-sm text-muted-foreground">
          עמוד {table.getState().pagination.pageIndex + 1} מתוך {table.getPageCount()}
        </span>
        <Button variant="outline" size="icon" onClick={() => table.previousPage()} disabled={!table.getCanPreviousPage()}>
          <ChevronRight className="h-4 w-4" />
        </Button>
        <Button variant="outline" size="icon" onClick={() => table.nextPage()} disabled={!table.getCanNextPage()}>
          <ChevronLeft className="h-4 w-4" />
        </Button>
      </div>
    </div>
  );
}
```

**UserDataTable.tsx:**
Main table wrapper using TanStack Table.
- Receives data and filter state
- Handles row click navigation to user profile
- Renders table header, body, pagination
- Applies client-side filtering based on toolbar state

```typescript
"use client";

import { useState, useMemo } from "react";
import { useRouter } from "next/navigation";
import {
  useReactTable,
  getCoreRowModel,
  getPaginationRowModel,
  getSortedRowModel,
  getFilteredRowModel,
  type SortingState,
  type ColumnFiltersState,
  flexRender,
} from "@tanstack/react-table";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { columns } from "./UserTableColumns";
import { UserTableToolbar } from "./UserTableToolbar";
import { UserTablePagination } from "./UserTablePagination";
import type { Profile } from "@/types/database";

interface UserDataTableProps {
  data: Profile[];
  initialSearch?: string;
  initialRole?: string | null;
  initialStatus?: string | null;
  initialShowDeleted?: boolean;
}

export function UserDataTable({ data, initialSearch = "", initialRole = null, initialStatus = null, initialShowDeleted = false }: UserDataTableProps) {
  const router = useRouter();
  const [sorting, setSorting] = useState<SortingState>([]);
  const [globalFilter, setGlobalFilter] = useState(initialSearch);
  const [roleFilter, setRoleFilter] = useState<string | null>(initialRole);
  const [statusFilter, setStatusFilter] = useState<string | null>(initialStatus);
  const [showDeleted, setShowDeleted] = useState(initialShowDeleted);

  // Filter data based on all criteria
  const filteredData = useMemo(() => {
    return data.filter((user) => {
      // Hide deleted by default
      if (!showDeleted && user.deleted_at) return false;

      // Global search (name, phone)
      if (globalFilter) {
        const searchLower = globalFilter.toLowerCase();
        const matchesName = user.full_name?.toLowerCase().includes(searchLower);
        const matchesPhone = user.phone?.includes(globalFilter);
        if (!matchesName && !matchesPhone) return false;
      }

      // Role filter
      if (roleFilter && user.role !== roleFilter) return false;

      // Status filter
      if (statusFilter) {
        const isActive = user.is_active;
        if (statusFilter === "active" && !isActive) return false;
        if (statusFilter === "inactive" && isActive) return false;
      }

      return true;
    });
  }, [data, globalFilter, roleFilter, statusFilter, showDeleted]);

  const table = useReactTable({
    data: filteredData,
    columns,
    state: { sorting },
    onSortingChange: setSorting,
    getCoreRowModel: getCoreRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    getSortedRowModel: getSortedRowModel(),
    initialState: { pagination: { pageSize: 10 } },
  });

  const handleRowClick = (userId: string) => {
    router.push(`/admin/users/${userId}`);
  };

  // ... render table with toolbar and pagination
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Table renders with sorting and pagination.
Row click navigates to user profile.
  </verify>
  <done>Data table and pagination components created with TanStack Table integration</done>
</task>

</tasks>

<verification>
1. TypeScript passes: `npx tsc --noEmit`
2. Build passes: `npm run build`
3. nuqs used for URL state
4. use-debounce used for search
5. TanStack Table used for data table
6. Row click navigates to profile page
</verification>

<success_criteria>
- Table displays with Avatar, Name, Phone, Role, Status columns
- Columns are sortable
- Search filters as you type (debounced)
- Role and Status dropdowns filter the list
- Pagination shows 10/20/50 per page options
- URL reflects current filter state
- Row click navigates to user profile
- Deleted users hidden by default
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-03-SUMMARY.md`
</output>
