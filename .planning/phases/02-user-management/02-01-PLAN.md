---
phase: 02-user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/lib/actions/admin-users.ts
  - src/lib/validations/user-create.ts
autonomous: true

must_haves:
  truths:
    - "Server actions exist for createUser, softDeleteUser, resetUserCredentials"
    - "Admin role verified in every server action before execution"
    - "User creation calls Supabase auth.admin.createUser()"
    - "Soft delete sets deleted_at timestamp instead of hard delete"
  artifacts:
    - path: "src/lib/actions/admin-users.ts"
      provides: "Server actions for admin user management"
      exports: ["createUserAction", "softDeleteUserAction", "resetUserCredentialsAction"]
    - path: "src/lib/validations/user-create.ts"
      provides: "Zod schema for user creation validation"
      exports: ["userCreateSchema", "CreateUserInput"]
  key_links:
    - from: "src/lib/actions/admin-users.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient import"
      pattern: "import.*createAdminClient.*from.*@/lib/supabase/admin"
    - from: "src/lib/actions/admin-users.ts"
      to: "src/lib/validations/user-create.ts"
      via: "schema import"
      pattern: "import.*userCreateSchema.*from.*@/lib/validations/user-create"
---

<objective>
Create server actions for admin user management operations.

Purpose: Establish the backend infrastructure for all admin user CRUD operations with proper security (admin role verification, Supabase Admin API for auth operations).

Output:
- Server actions file with createUser, softDeleteUser, resetUserCredentials
- Validation schema for user creation
- Dependencies installed (TanStack Table, nuqs, papaparse, use-debounce)
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-user-management/02-CONTEXT.md
@.planning/phases/02-user-management/02-RESEARCH.md

Key existing files:
@src/lib/supabase/admin.ts - createAdminClient() already exists
@src/lib/validations/user-edit.ts - pattern for validation with phone regex
@src/components/admin/UserEditForm.tsx - existing patterns for activity logging
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies</name>
  <files>package.json, package-lock.json</files>
  <action>
Install required dependencies for Phase 2:
```bash
npm install @tanstack/react-table nuqs papaparse use-debounce
npm install -D @types/papaparse
```

These are needed for:
- @tanstack/react-table: Data table with sorting, filtering, pagination
- nuqs: Type-safe URL state management for filters
- papaparse: CSV parsing/generation for import/export
- use-debounce: Debounced search input
  </action>
  <verify>
Run `npm ls @tanstack/react-table nuqs papaparse use-debounce` and verify all packages are listed.
Run `npm run build` to ensure no installation issues.
  </verify>
  <done>All 4 packages installed and build passes</done>
</task>

<task type="auto">
  <name>Task 2: Create user creation validation schema</name>
  <files>src/lib/validations/user-create.ts</files>
  <action>
Create validation schema for user creation. Reference existing patterns from `user-edit.ts`.

Required fields per CONTEXT.md:
- full_name: Required, 2-100 chars
- phone: Required, Israeli format (0XX or +972XX)
- role: Required, enum (trainee, trainer, admin)
- email: Optional, valid email format

Schema structure:
```typescript
import { z } from "zod";

const phoneRegex = /^0\d{9}$|^\+972\d{9}$/;

export const userCreateSchema = z.object({
  full_name: z.string().min(2, "שם חייב להכיל לפחות 2 תווים").max(100, "שם ארוך מדי"),
  phone: z.string().regex(phoneRegex, "מספר טלפון לא תקין (פורמט: 0501234567 או +972501234567)"),
  role: z.enum(["trainee", "trainer", "admin"]),
  email: z.string().email("כתובת אימייל לא תקינה").optional().or(z.literal("")),
});

export type CreateUserInput = z.infer<typeof userCreateSchema>;
```
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
Schema exports are importable from other files.
  </verify>
  <done>userCreateSchema exported and validates required fields</done>
</task>

<task type="auto">
  <name>Task 3: Create server actions for admin user management</name>
  <files>src/lib/actions/admin-users.ts</files>
  <action>
Create server actions file with "use server" directive. Each action must:
1. Verify caller is authenticated
2. Verify caller has admin role
3. Use createAdminClient() for privileged operations
4. Log activity to activity_logs table
5. Call revalidatePath("/admin/users") on success
6. Return structured response: { success: true } or { error: string, fieldErrors?: Record<string, string[]> }

Three server actions:

**createUserAction(input: CreateUserInput)**
- Validate input with userCreateSchema
- Format phone to +972 format for Supabase
- Call `adminClient.auth.admin.createUser({ phone, phone_confirm: true, user_metadata: { full_name } })`
- Update profile with role (profile auto-created by trigger, use update not insert)
- Log activity with action "user_created"
- Handle "already registered" error specially

**softDeleteUserAction(userId: string)**
- Validate userId is valid UUID
- Prevent self-deletion (compare with current user id)
- Set deleted_at timestamp: `adminClient.from("profiles").update({ deleted_at: new Date().toISOString() }).eq("id", userId)`
- Log activity with action "user_deleted"

**resetUserCredentialsAction(userId: string)**
- Get target user info via adminClient.auth.admin.getUserById
- Generate magic link via adminClient.auth.admin.generateLink
- For phone-based users, the link won't be sent automatically (note this in return)
- Log activity with action "credentials_reset"
- Return { success: true, message: "..." } indicating what was done

Reference 02-RESEARCH.md for exact patterns and error handling.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
File exports all three functions.
Admin verification logic present in all actions.
  </verify>
  <done>
Three server actions exported: createUserAction, softDeleteUserAction, resetUserCredentialsAction.
All actions verify admin role before execution.
All actions use createAdminClient() for privileged operations.
  </done>
</task>

</tasks>

<verification>
1. Dependencies installed: `npm ls @tanstack/react-table nuqs papaparse use-debounce` shows all packages
2. TypeScript passes: `npx tsc --noEmit` has no errors
3. Build passes: `npm run build` completes successfully
4. Server actions file exists with correct exports
5. Validation schema exports CreateUserInput type
</verification>

<success_criteria>
- All 4 new packages in package.json
- userCreateSchema validates name, phone, role, optional email
- createUserAction creates user via Supabase Admin API
- softDeleteUserAction sets deleted_at instead of hard delete
- All actions verify admin role before execution
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-01-SUMMARY.md`
</output>
