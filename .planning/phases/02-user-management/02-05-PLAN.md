---
phase: 02-user-management
plan: 05
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - src/components/admin/users/UserImportDialog.tsx
  - src/components/admin/users/UserExportButton.tsx
  - src/lib/validations/user-import.ts
  - src/lib/actions/admin-users.ts
autonomous: true

must_haves:
  truths:
    - "Import button opens dialog for CSV upload"
    - "CSV file is validated row by row"
    - "Invalid rows are skipped with error report shown"
    - "Valid rows are created as users"
    - "Export button downloads CSV of current filtered view"
  artifacts:
    - path: "src/components/admin/users/UserImportDialog.tsx"
      provides: "CSV import dialog with file upload and validation"
      exports: ["UserImportDialog"]
    - path: "src/components/admin/users/UserExportButton.tsx"
      provides: "Button to export users to CSV"
      exports: ["UserExportButton"]
    - path: "src/lib/validations/user-import.ts"
      provides: "Validation schema for CSV import rows"
      exports: ["csvRowSchema", "CSVUserRow"]
  key_links:
    - from: "src/components/admin/users/UserImportDialog.tsx"
      to: "papaparse"
      via: "Papa.parse for CSV parsing"
      pattern: "import.*Papa.*from.*papaparse"
    - from: "src/components/admin/users/UserExportButton.tsx"
      to: "papaparse"
      via: "Papa.unparse for CSV generation"
      pattern: "import.*Papa.*from.*papaparse"
---

<objective>
Create CSV import and export functionality for bulk user operations.

Purpose: Enable admins to bulk create users via CSV import and export user lists for reporting.

Output:
- CSV import dialog with validation and error reporting
- CSV export button
- Import validation schema
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-user-management/02-CONTEXT.md
@.planning/phases/02-user-management/02-RESEARCH.md
@.planning/phases/02-user-management/02-01-SUMMARY.md
@.planning/phases/02-user-management/02-03-SUMMARY.md

Key files:
@src/lib/validations/user-create.ts - validation patterns
@src/lib/actions/admin-users.ts - server actions to extend
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV import validation schema</name>
  <files>src/lib/validations/user-import.ts</files>
  <action>
Create Zod schema for validating CSV import rows.

CSV columns per CONTEXT.md: Name, Phone, Role, Email (optional)

```typescript
import { z } from "zod";

const phoneRegex = /^0\d{9}$|^\+972\d{9}$/;

export const csvRowSchema = z.object({
  name: z.string().min(2, "שם חייב להכיל לפחות 2 תווים").max(100),
  phone: z.string().regex(phoneRegex, "מספר טלפון לא תקין"),
  role: z.enum(["trainee", "trainer", "admin"]).default("trainee"),
  email: z.string().email().optional().or(z.literal("")).transform(v => v || undefined),
});

export type CSVUserRow = z.infer<typeof csvRowSchema>;

// Type for validation result
export interface CSVValidationResult {
  valid: CSVUserRow[];
  errors: Array<{
    row: number;
    data: Record<string, string>;
    errors: string[];
  }>;
}
```

Schema should handle:
- Empty email fields (transform to undefined)
- Missing role (default to trainee)
- Hebrew and English column names mapping
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Schema validates sample data correctly.
  </verify>
  <done>CSV row validation schema created with proper transforms</done>
</task>

<task type="auto">
  <name>Task 2: Add bulk import server action</name>
  <files>src/lib/actions/admin-users.ts</files>
  <action>
Add server action for bulk user import.

```typescript
export async function bulkCreateUsersAction(users: CSVUserRow[]): Promise<{
  success: boolean;
  created: number;
  errors: Array<{ row: number; phone: string; error: string }>;
}> {
  // Verify admin (same pattern as other actions)
  ...

  const adminClient = createAdminClient();
  const created: string[] = [];
  const errors: Array<{ row: number; phone: string; error: string }> = [];

  for (let i = 0; i < users.length; i++) {
    const user = users[i];
    try {
      // Format phone
      const formattedPhone = user.phone.startsWith("+")
        ? user.phone
        : `+972${user.phone.slice(1)}`;

      // Create user
      const { data: authData, error: authError } = await adminClient.auth.admin.createUser({
        phone: formattedPhone,
        phone_confirm: true,
        email: user.email || undefined,
        email_confirm: !!user.email,
        user_metadata: { full_name: user.name },
      });

      if (authError) {
        errors.push({
          row: i + 1,
          phone: user.phone,
          error: authError.message.includes("already registered")
            ? "מספר טלפון כבר רשום"
            : authError.message,
        });
        continue;
      }

      // Update profile with role
      await adminClient
        .from("profiles")
        .update({ full_name: user.name, role: user.role, phone: formattedPhone })
        .eq("id", authData.user.id);

      created.push(authData.user.id);
    } catch (error) {
      errors.push({
        row: i + 1,
        phone: user.phone,
        error: error instanceof Error ? error.message : "שגיאה לא ידועה",
      });
    }
  }

  // Log bulk activity
  if (created.length > 0) {
    await adminClient.from("activity_logs").insert({
      user_id: created[0], // First created user
      action: "bulk_users_created",
      actor_id: adminUserId,
      actor_name: adminName,
      changes: [{ field: "count", new_value: created.length }],
    });
  }

  revalidatePath("/admin/users");

  return {
    success: errors.length === 0,
    created: created.length,
    errors,
  };
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Function exported from actions file.
  </verify>
  <done>bulkCreateUsersAction server action added to admin-users.ts</done>
</task>

<task type="auto">
  <name>Task 3: Create UserImportDialog and UserExportButton</name>
  <files>src/components/admin/users/UserImportDialog.tsx, src/components/admin/users/UserExportButton.tsx</files>
  <action>
**UserImportDialog.tsx:**
Dialog for CSV file upload with validation preview.

Features:
- File input for CSV
- Parse with PapaParse
- Validate each row with csvRowSchema
- Show preview of valid rows
- Show list of invalid rows with errors
- Import button to create valid users
- Progress indicator during import

```typescript
"use client";

import { useState, useCallback } from "react";
import Papa from "papaparse";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { ScrollArea } from "@/components/ui/scroll-area";
import { toast } from "sonner";
import { Upload, Loader2, AlertCircle, CheckCircle } from "lucide-react";
import { csvRowSchema, type CSVUserRow, type CSVValidationResult } from "@/lib/validations/user-import";
import { bulkCreateUsersAction } from "@/lib/actions/admin-users";

export function UserImportDialog() {
  const [open, setOpen] = useState(false);
  const [file, setFile] = useState<File | null>(null);
  const [validation, setValidation] = useState<CSVValidationResult | null>(null);
  const [importing, setImporting] = useState(false);
  const [result, setResult] = useState<{ created: number; errors: number } | null>(null);

  const handleFileChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = e.target.files?.[0];
    if (!selectedFile) return;

    setFile(selectedFile);
    setResult(null);

    // Parse and validate CSV
    Papa.parse(selectedFile, {
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        const valid: CSVUserRow[] = [];
        const errors: CSVValidationResult["errors"] = [];

        // Map possible Hebrew column names
        const mapRow = (row: Record<string, string>) => ({
          name: row["name"] || row["שם"] || "",
          phone: row["phone"] || row["טלפון"] || "",
          role: row["role"] || row["תפקיד"] || "trainee",
          email: row["email"] || row["אימייל"] || "",
        });

        results.data.forEach((rawRow, index) => {
          const row = mapRow(rawRow as Record<string, string>);
          const parsed = csvRowSchema.safeParse(row);

          if (parsed.success) {
            valid.push(parsed.data);
          } else {
            errors.push({
              row: index + 2, // +2 for header and 0-index
              data: row,
              errors: parsed.error.issues.map(i => i.message),
            });
          }
        });

        setValidation({ valid, errors });
      },
    });
  }, []);

  const handleImport = async () => {
    if (!validation?.valid.length) return;

    setImporting(true);
    try {
      const result = await bulkCreateUsersAction(validation.valid);

      setResult({
        created: result.created,
        errors: result.errors.length,
      });

      if (result.created > 0) {
        toast.success(`נוצרו ${result.created} משתמשים`);
      }
      if (result.errors.length > 0) {
        toast.error(`${result.errors.length} שגיאות ביבוא`);
      }
    } catch (error) {
      toast.error("שגיאה ביבוא המשתמשים");
    } finally {
      setImporting(false);
    }
  };

  // ... render dialog with file input, validation preview, import button
}
```

**UserExportButton.tsx:**
Button to export current users to CSV.

```typescript
"use client";

import Papa from "papaparse";
import { Button } from "@/components/ui/button";
import { Download } from "lucide-react";
import type { Profile } from "@/types/database";

interface UserExportButtonProps {
  users: Profile[];
}

export function UserExportButton({ users }: UserExportButtonProps) {
  const handleExport = () => {
    const csvData = users.map(user => ({
      שם: user.full_name || "",
      טלפון: user.phone ? (user.phone.startsWith("+972") ? "0" + user.phone.slice(4) : user.phone) : "",
      תפקיד: user.role === "admin" ? "מנהל" : user.role === "trainer" ? "מאמן" : "מתאמן",
      סטטוס: user.is_active ? "פעיל" : "לא פעיל",
      "תאריך הצטרפות": new Date(user.created_at).toLocaleDateString("he-IL"),
    }));

    const csv = Papa.unparse(csvData);
    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" }); // BOM for Hebrew
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `משתמשים-${new Date().toISOString().split("T")[0]}.csv`;
    link.click();
  };

  return (
    <Button variant="outline" onClick={handleExport}>
      <Download className="h-4 w-4 ml-2" />
      ייצוא ל-CSV
    </Button>
  );
}
```

Note: Export uses Hebrew column names and includes BOM for proper Hebrew display in Excel.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Both components export correctly.
PapaParse imported and used.
  </verify>
  <done>UserImportDialog and UserExportButton components created with PapaParse integration</done>
</task>

</tasks>

<verification>
1. TypeScript passes: `npx tsc --noEmit`
2. Build passes: `npm run build`
3. PapaParse used for both import and export
4. Import validates each row individually
5. Invalid rows shown with error messages
6. Export includes BOM for Hebrew support
</verification>

<success_criteria>
- Import dialog allows CSV file selection
- CSV rows validated individually (invalid rows skipped)
- Validation errors shown with row numbers
- Valid rows can be imported as users
- Export downloads CSV with Hebrew column names
- Export works with current filtered view
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-05-SUMMARY.md`
</output>
