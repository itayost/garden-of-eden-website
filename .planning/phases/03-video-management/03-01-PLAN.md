---
phase: 03-video-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/validations/video.ts
  - src/lib/utils/youtube.ts
  - src/lib/actions/admin-videos.ts
autonomous: true

must_haves:
  truths:
    - "Server actions validate video input with zod schema"
    - "YouTube URLs are validated for correct format and ID extraction"
    - "Admin verification prevents unauthorized video operations"
  artifacts:
    - path: "src/lib/validations/video.ts"
      provides: "Video validation schema"
      exports: ["videoSchema", "VideoInput", "getDayTopicSuggestion"]
    - path: "src/lib/utils/youtube.ts"
      provides: "YouTube URL utilities"
      exports: ["getYouTubeId", "getYouTubeThumbnail", "getYouTubeEmbedUrl"]
    - path: "src/lib/actions/admin-videos.ts"
      provides: "CRUD server actions"
      exports: ["createVideoAction", "updateVideoAction", "deleteVideoAction"]
  key_links:
    - from: "src/lib/actions/admin-videos.ts"
      to: "src/lib/validations/video.ts"
      via: "import videoSchema"
      pattern: "import.*videoSchema.*from"
    - from: "src/lib/actions/admin-videos.ts"
      to: "verifyAdmin()"
      via: "admin verification"
      pattern: "await verifyAdmin\\(\\)"
---

<objective>
Create video validation schema and server actions for admin video CRUD operations.

Purpose: Establish the foundation for video management - validation rules and server-side operations that components will consume.
Output: Three files - video validation schema, YouTube utilities, server actions for create/update/delete.
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-video-management/03-CONTEXT.md
@.planning/phases/03-video-management/03-RESEARCH.md

# Existing patterns to follow
@src/lib/actions/admin-users.ts
@src/lib/validations/user-create.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create YouTube URL utilities</name>
  <files>src/lib/utils/youtube.ts</files>
  <action>
Create YouTube utility functions following the existing `getYouTubeId` pattern from VideoCard.tsx.

Include:
1. `getYouTubeId(url: string): string | null` - Extract 11-character video ID from multiple URL formats:
   - youtube.com/watch?v=VIDEO_ID
   - youtube.com/shorts/VIDEO_ID
   - youtu.be/VIDEO_ID
   - youtube.com/embed/VIDEO_ID

2. `getYouTubeThumbnail(videoId: string, quality?: "default" | "mqdefault" | "hqdefault" | "sddefault" | "maxresdefault"): string`
   - Default quality: mqdefault (320x180)
   - Returns: `https://img.youtube.com/vi/${videoId}/${quality}.jpg`

3. `getYouTubeEmbedUrl(videoId: string, autoplay?: boolean): string`
   - Returns embed URL with optional autoplay param

Add JSDoc comments for each function with example usage.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>YouTube utility file exports three functions with proper TypeScript types</done>
</task>

<task type="auto">
  <name>Task 2: Create video validation schema</name>
  <files>src/lib/validations/video.ts</files>
  <action>
Create zod validation schema following user-create.ts pattern.

Schema fields:
- `title`: string, min 2 chars, max 200 chars (Hebrew messages)
- `youtube_url`: string, valid URL, must pass `getYouTubeId()` extraction test
- `day_number`: coerce.number, min 1, max 5
- `day_topic`: string, min 2 chars
- `duration_minutes`: coerce.number, min 1, max 120
- `description`: string, max 1000 chars, optional (allow empty string)
- `order_index`: coerce.number, optional (auto-calculated if not provided)

Export:
- `videoSchema` - the zod schema
- `VideoInput` - z.infer type
- `getDayTopicSuggestion(dayNumber: number): string` - returns default topic for day 1-5

Day topic suggestions (Hebrew):
1. "גמישות ויציבות"
2. "כוח רגליים"
3. "זריזות וקואורדינציה"
4. "סיבולת לב-ריאה"
5. "שיקום והתאוששות"

Import getYouTubeId from youtube.ts for URL validation refine.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Video schema exports with all validation rules and Hebrew error messages</done>
</task>

<task type="auto">
  <name>Task 3: Create video server actions</name>
  <files>src/lib/actions/admin-videos.ts</files>
  <action>
Create server actions following admin-users.ts pattern exactly.

Include:
1. Import existing `verifyAdmin` pattern (copy the function or import if available)
2. Define `ActionResult` type: `{ success: true; videoId?: string } | { error: string; fieldErrors?: Record<string, string[]> }`
3. UUID_REGEX constant for video ID validation

Actions:
**createVideoAction(input: VideoInput): Promise<ActionResult>**
- Call verifyAdmin() first
- Validate input with videoSchema
- Calculate order_index: query max order_index for that day_number, increment by 1
- Insert to workout_videos using adminClient
- revalidatePath("/admin/videos")
- Return { success: true, videoId }

**updateVideoAction(videoId: string, input: VideoInput): Promise<ActionResult>**
- Call verifyAdmin() first
- Validate videoId with UUID_REGEX
- Validate input with videoSchema
- Update workout_videos where id = videoId
- revalidatePath("/admin/videos")
- Return { success: true, videoId }

**deleteVideoAction(videoId: string): Promise<ActionResult>**
- Call verifyAdmin() first
- Validate videoId with UUID_REGEX
- Hard delete from workout_videos (not soft delete - videos don't have deleted_at)
- revalidatePath("/admin/videos")
- Return { success: true }

Use Hebrew error messages consistent with admin-users.ts.
Log errors with console.error for debugging.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Three server actions export and handle CRUD with admin verification</done>
</task>

</tasks>

<verification>
1. All three files exist and export expected functions/types
2. TypeScript compiles without errors
3. No unused imports or variables
</verification>

<success_criteria>
- Video validation schema rejects invalid YouTube URLs
- Video validation schema enforces day_number 1-5 range
- Server actions verify admin before any mutation
- Server actions return consistent ActionResult type
- revalidatePath called after mutations for UI refresh
</success_criteria>

<output>
After completion, create `.planning/phases/03-video-management/03-01-SUMMARY.md`
</output>
