---
phase: 01-security-fixes
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/validations/payment.ts
  - src/app/api/payments/create/route.ts
autonomous: true

must_haves:
  truths:
    - "Payment endpoint returns 429 for excessive requests"
    - "Invalid payment data returns 400 with field-level errors"
    - "Rate limit error messages do not reveal rate limiting mechanism"
    - "Admins are not rate limited"
  artifacts:
    - path: "src/lib/validations/payment.ts"
      provides: "Payment Zod schema"
      exports: ["createPaymentSchema", "CreatePaymentInput"]
      min_lines: 25
    - path: "src/app/api/payments/create/route.ts"
      provides: "Rate-limited, validated payment endpoint"
      contains: "checkRateLimit"
      min_lines: 80
  key_links:
    - from: "src/app/api/payments/create/route.ts"
      to: "src/lib/rate-limit.ts"
      via: "checkRateLimit import"
      pattern: "from.*rate-limit"
    - from: "src/app/api/payments/create/route.ts"
      to: "src/lib/validations/payment.ts"
      via: "createPaymentSchema import"
      pattern: "from.*validations/payment"
---

<objective>
Secure the payment endpoint with rate limiting and Zod validation.

Purpose: Prevent payment abuse (rate limiting) and ensure all input is validated before processing (Zod schema).
Output: Rate-limited payment endpoint with proper Zod validation and Hebrew error messages.
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-fixes/01-CONTEXT.md
@.planning/phases/01-security-fixes/01-RESEARCH.md
@src/app/api/payments/create/route.ts
@src/lib/rate-limit.ts (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payment validation schema</name>
  <files>src/lib/validations/payment.ts</files>
  <action>
Create `src/lib/validations/payment.ts` with Zod schemas for payment endpoint.

Using Zod 4.x syntax (project uses zod ^4.2.1):

```typescript
import { z } from "zod";

/**
 * Schema for creating a payment via /api/payments/create
 * Hebrew error messages for user-facing validation
 */
export const createPaymentSchema = z.object({
  amount: z
    .number({ error: "סכום לא תקין" })
    .positive({ error: "סכום חייב להיות חיובי" }),

  description: z
    .string()
    .min(1, { error: "תיאור נדרש" })
    .max(500, { error: "תיאור ארוך מדי (עד 500 תווים)" }),

  paymentType: z.enum(["one_time", "recurring"], {
    error: "סוג תשלום לא תקין",
  }),

  payerName: z
    .string()
    .min(2, { error: "שם קצר מדי" })
    .max(100, { error: "שם ארוך מדי" })
    .refine(
      (name) => {
        const parts = name.trim().split(/\s+/);
        return parts.length >= 2 && parts.every((p) => p.length >= 2);
      },
      { message: "נא להזין שם מלא (פרטי ומשפחה)" }
    ),

  payerPhone: z
    .string()
    .regex(/^05\d{8}$/, { error: "מספר טלפון לא תקין (דוגמה: 0501234567)" }),

  payerEmail: z
    .string()
    .email({ error: "כתובת אימייל לא תקינה" })
    .optional()
    .or(z.literal("")),

  paymentNum: z
    .number()
    .int({ error: "מספר תשלומים חייב להיות מספר שלם" })
    .positive({ error: "מספר תשלומים חייב להיות חיובי" })
    .optional(),

  maxPaymentNum: z
    .number()
    .int({ error: "מספר תשלומים מקסימלי חייב להיות מספר שלם" })
    .positive({ error: "מספר תשלומים מקסימלי חייב להיות חיובי" })
    .optional(),
});

export type CreatePaymentInput = z.infer<typeof createPaymentSchema>;

/**
 * Format Zod errors for API response
 * Returns field-level errors for inline display
 */
export function formatZodErrors(error: z.ZodError): Record<string, string> {
  const errors: Record<string, string> = {};
  for (const issue of error.issues) {
    const path = issue.path.join(".");
    if (!errors[path]) {
      errors[path] = issue.message;
    }
  }
  return errors;
}
```
  </action>
  <verify>
```bash
npx tsc --noEmit src/lib/validations/payment.ts
grep -E "export (const|type|function)" src/lib/validations/payment.ts
```
  </verify>
  <done>
- src/lib/validations/payment.ts exists
- Exports createPaymentSchema, CreatePaymentInput, formatZodErrors
- All error messages in Hebrew
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add rate limiting and validation to payment endpoint</name>
  <files>src/app/api/payments/create/route.ts</files>
  <action>
Update `src/app/api/payments/create/route.ts` to:

1. Add imports:
   - `checkRateLimit`, `getRateLimitIdentifier` from `@/lib/rate-limit`
   - `createPaymentSchema`, `formatZodErrors` from `@/lib/validations/payment`
   - `waitUntil` from `@vercel/functions`

2. At the START of the POST handler, before any other logic:
   a. Get identifier for rate limiting:
      - This endpoint is anonymous, so use IP: `request.headers.get("x-forwarded-for")?.split(",")[0] || "unknown"`
   b. Check rate limit with type "payment" (10/hour):
      ```typescript
      const ip = request.headers.get("x-forwarded-for")?.split(",")[0] || "unknown";
      const identifier = getRateLimitIdentifier(null, ip);
      const { rateLimited, pending } = await checkRateLimit(identifier, "payment");
      waitUntil(pending);

      if (rateLimited) {
        return NextResponse.json(
          { error: "הבקשה נכשלה. נסה שוב מאוחר יותר" }, // Vague Hebrew message
          { status: 429 }
        );
      }
      ```

3. Replace manual validation with Zod:
   ```typescript
   const body = await request.json();
   const result = createPaymentSchema.safeParse(body);

   if (!result.success) {
     return NextResponse.json(
       { error: "נתונים לא תקינים", fields: formatZodErrors(result.error) },
       { status: 400 }
     );
   }

   const validated = result.data;
   ```

4. Use `validated` instead of `body` for all subsequent logic.

5. Remove all the manual validation code (the series of if-checks for amount, description, paymentType, etc.)

6. Keep the GROW API call and Supabase insert logic, but use validated data.

Important:
- Error message for rate limiting is intentionally vague per CONTEXT.md
- Keep Hebrew error messages
- The endpoint remains unauthenticated (anyone can pay)
  </action>
  <verify>
```bash
npx tsc --noEmit src/app/api/payments/create/route.ts
grep "checkRateLimit" src/app/api/payments/create/route.ts
grep "createPaymentSchema.safeParse" src/app/api/payments/create/route.ts
npm run lint -- --quiet
```
  </verify>
  <done>
- Payment endpoint uses checkRateLimit at start of handler
- Payment endpoint uses Zod safeParse for validation
- Manual if-check validations removed
- Returns 429 with vague Hebrew message on rate limit
- Returns 400 with field-level errors on validation failure
- TypeScript and ESLint pass
  </done>
</task>

</tasks>

<verification>
1. Zod schema compiles: `npx tsc --noEmit src/lib/validations/payment.ts`
2. Route compiles: `npx tsc --noEmit src/app/api/payments/create/route.ts`
3. Rate limiting integrated: `grep "checkRateLimit" src/app/api/payments/create/route.ts`
4. Zod validation integrated: `grep "safeParse" src/app/api/payments/create/route.ts`
5. Manual validation removed: `grep -c "if (!body." src/app/api/payments/create/route.ts` (should be 0 or 1 for GROW response check only)
6. Lint passes: `npm run lint`
</verification>

<success_criteria>
- src/lib/validations/payment.ts exports createPaymentSchema and formatZodErrors
- Payment endpoint calls checkRateLimit before processing
- Payment endpoint uses Zod safeParse instead of manual validation
- Rate limit returns 429 with vague Hebrew message
- Validation errors return 400 with field-level errors
- TypeScript and ESLint pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-fixes/01-03-SUMMARY.md`
</output>
