---
phase: 01-security-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/YYYYMMDDHHMMSS_security_indexes_and_soft_delete.sql
autonomous: true

must_haves:
  truths:
    - "Soft deleted records are hidden from normal queries"
    - "Admins can still see soft deleted records"
    - "Security-critical queries on activity_logs are fast"
    - "Users cannot hard delete their own assessments"
  artifacts:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_security_indexes_and_soft_delete.sql"
      provides: "Database security enhancements"
      contains: "deleted_at"
      min_lines: 50
  key_links:
    - from: "RLS policy"
      to: "profiles.role"
      via: "Admin visibility check"
      pattern: "role.*admin"
---

<objective>
Add database security enhancements: soft delete columns, security indexes, and UPDATE/DELETE RLS policies.

Purpose: Ensure data preservation with soft deletes, improve query performance on security-critical tables, and prevent unauthorized data modification.
Output: Supabase migration with indexes, soft delete columns, and RLS policies.
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-fixes/01-CONTEXT.md
@.planning/phases/01-security-fixes/01-RESEARCH.md
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security migration</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_security_indexes_and_soft_delete.sql</files>
  <action>
Create a new migration file in `supabase/migrations/` directory. Use current timestamp for filename (format: YYYYMMDDHHMMSS_security_indexes_and_soft_delete.sql).

If `supabase/migrations/` doesn't exist, create it first.

Migration content:

```sql
-- Security Indexes and Soft Delete Migration
-- Phase 1: Security Fixes

-- ============================================
-- 1. SECURITY-CRITICAL INDEXES
-- ============================================

-- Index on activity_logs for fast user audit queries
CREATE INDEX IF NOT EXISTS idx_activity_logs_user_id
  ON activity_logs(user_id);

-- Index on activity_logs for time-based queries
CREATE INDEX IF NOT EXISTS idx_activity_logs_created_at
  ON activity_logs(created_at DESC);

-- Composite index for common query pattern
CREATE INDEX IF NOT EXISTS idx_activity_logs_user_created
  ON activity_logs(user_id, created_at DESC);

-- ============================================
-- 2. SOFT DELETE COLUMNS
-- ============================================

-- Add deleted_at to profiles (users)
ALTER TABLE profiles
  ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ DEFAULT NULL;

-- Add deleted_at to player_assessments
ALTER TABLE player_assessments
  ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ DEFAULT NULL;

-- Partial unique index for profiles - only active users must have unique phone
-- (Allows re-creation of soft-deleted accounts)
DROP INDEX IF EXISTS idx_profiles_phone_unique_active;
CREATE UNIQUE INDEX idx_profiles_phone_unique_active
  ON profiles(phone)
  WHERE deleted_at IS NULL AND phone IS NOT NULL;

-- Partial unique index for assessments - prevent duplicate assessments on same date for active records
DROP INDEX IF EXISTS idx_assessments_user_date_active;
CREATE UNIQUE INDEX idx_assessments_user_date_active
  ON player_assessments(user_id, assessment_date)
  WHERE deleted_at IS NULL;

-- ============================================
-- 3. RLS POLICIES - SELECT (with soft delete)
-- ============================================

-- Drop existing SELECT policies to replace with soft-delete aware versions
DROP POLICY IF EXISTS "Users can view own profile" ON profiles;
DROP POLICY IF EXISTS "Admins can view all profiles" ON profiles;
DROP POLICY IF EXISTS "Users can view own assessments" ON player_assessments;
DROP POLICY IF EXISTS "Admins can view all assessments" ON player_assessments;

-- Profiles: Users see own (not deleted), Admins see all
CREATE POLICY "Users can view own profile" ON profiles
  FOR SELECT
  TO authenticated
  USING (
    id = (SELECT auth.uid())
    AND deleted_at IS NULL
  );

CREATE POLICY "Admins can view all profiles" ON profiles
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = (SELECT auth.uid())
      AND role = 'admin'
    )
  );

-- Assessments: Users see own (not deleted), Admins see all
CREATE POLICY "Users can view own assessments" ON player_assessments
  FOR SELECT
  TO authenticated
  USING (
    user_id = (SELECT auth.uid())
    AND deleted_at IS NULL
  );

CREATE POLICY "Admins can view all assessments" ON player_assessments
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = (SELECT auth.uid())
      AND role = 'admin'
    )
  );

-- ============================================
-- 4. RLS POLICIES - UPDATE
-- ============================================

-- Profiles: Users can update own profile (not deleted)
DROP POLICY IF EXISTS "Users can update own profile" ON profiles;
CREATE POLICY "Users can update own profile" ON profiles
  FOR UPDATE
  TO authenticated
  USING (id = (SELECT auth.uid()) AND deleted_at IS NULL)
  WITH CHECK (id = (SELECT auth.uid()) AND deleted_at IS NULL);

-- Profiles: Admins can update any profile
DROP POLICY IF EXISTS "Admins can update all profiles" ON profiles;
CREATE POLICY "Admins can update all profiles" ON profiles
  FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = (SELECT auth.uid())
      AND role = 'admin'
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = (SELECT auth.uid())
      AND role = 'admin'
    )
  );

-- Assessments: Only admins/trainers can update
DROP POLICY IF EXISTS "Trainers can update assessments" ON player_assessments;
CREATE POLICY "Trainers can update assessments" ON player_assessments
  FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = (SELECT auth.uid())
      AND role IN ('admin', 'trainer')
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = (SELECT auth.uid())
      AND role IN ('admin', 'trainer')
    )
  );

-- ============================================
-- 5. RLS POLICIES - DELETE (block hard deletes)
-- ============================================

-- Profiles: Nobody can hard delete (use soft delete via UPDATE)
DROP POLICY IF EXISTS "No hard delete profiles" ON profiles;
CREATE POLICY "No hard delete profiles" ON profiles
  FOR DELETE
  TO authenticated
  USING (false);

-- Assessments: Nobody can hard delete (use soft delete via UPDATE)
DROP POLICY IF EXISTS "No hard delete assessments" ON player_assessments;
CREATE POLICY "No hard delete assessments" ON player_assessments
  FOR DELETE
  TO authenticated
  USING (false);

-- ============================================
-- 6. CASCADE SOFT DELETE FUNCTION
-- ============================================

-- Function to soft delete user and all their data
CREATE OR REPLACE FUNCTION soft_delete_user(target_user_id UUID)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- Check if caller is admin
  IF NOT EXISTS (
    SELECT 1 FROM profiles
    WHERE id = auth.uid()
    AND role = 'admin'
  ) THEN
    RAISE EXCEPTION 'Only admins can soft delete users';
  END IF;

  -- Soft delete the user profile
  UPDATE profiles
  SET deleted_at = NOW()
  WHERE id = target_user_id;

  -- Soft delete all their assessments
  UPDATE player_assessments
  SET deleted_at = NOW()
  WHERE user_id = target_user_id;

  -- Note: Forms (pre_workout, post_workout, nutrition) are audit logs
  -- and should NOT be soft deleted - they're immutable records
END;
$$;

-- ============================================
-- 7. COMMENTS FOR DOCUMENTATION
-- ============================================

COMMENT ON COLUMN profiles.deleted_at IS 'Soft delete timestamp. NULL = active, non-NULL = deleted';
COMMENT ON COLUMN player_assessments.deleted_at IS 'Soft delete timestamp. NULL = active, non-NULL = deleted';
COMMENT ON FUNCTION soft_delete_user IS 'Admin-only function to soft delete a user and cascade to their assessments';
```
  </action>
  <verify>
Check migration file exists and has correct content:
```bash
ls supabase/migrations/*security_indexes_and_soft_delete.sql
grep -c "deleted_at" supabase/migrations/*security_indexes_and_soft_delete.sql
grep -c "CREATE POLICY" supabase/migrations/*security_indexes_and_soft_delete.sql
```
  </verify>
  <done>
- Migration file created with soft delete columns for profiles and player_assessments
- Security indexes on activity_logs created
- UPDATE policies allow users to update own data, admins to update all
- DELETE policies block all hard deletes
- soft_delete_user function for admin cascade delete
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply migration to remote database</name>
  <files>N/A (database operation)</files>
  <action>
Apply the migration to the Supabase project using Supabase CLI.

First, check if Supabase CLI is linked to the project:
```bash
npx supabase projects list
```

If linked, apply the migration:
```bash
npx supabase db push
```

If NOT linked or push fails, the migration can be applied manually via Supabase Dashboard:
1. Go to SQL Editor in Supabase Dashboard
2. Copy-paste the migration SQL
3. Execute

Note: If the Supabase CLI is not configured, create a checkpoint for manual application.
  </action>
  <verify>
Verify migration applied by checking for new columns:
```bash
# Via Supabase CLI (if configured)
npx supabase db diff

# Or check locally that migration file is ready for deployment
cat supabase/migrations/*security_indexes_and_soft_delete.sql | head -20
```
  </verify>
  <done>
- Migration file exists and is ready for deployment
- If Supabase CLI is configured, migration is applied to remote database
- If not, migration is ready for manual application via Dashboard
  </done>
</task>

</tasks>

<verification>
1. Migration file exists: `ls supabase/migrations/*security_indexes_and_soft_delete.sql`
2. Contains soft delete: `grep "deleted_at" supabase/migrations/*.sql`
3. Contains RLS policies: `grep "CREATE POLICY" supabase/migrations/*.sql | wc -l` (should be 8+)
4. Contains indexes: `grep "CREATE INDEX" supabase/migrations/*.sql | wc -l` (should be 3+)
</verification>

<success_criteria>
- Migration file created in supabase/migrations/
- profiles and player_assessments have deleted_at column defined
- activity_logs has user_id and created_at indexes defined
- UPDATE policies for users and admins defined
- DELETE policies block all hard deletes
- soft_delete_user function defined for cascade soft delete
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-fixes/01-02-SUMMARY.md`
</output>
