---
phase: 01-security-fixes
plan: 05
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - src/types/database.ts
  - src/app/dashboard/page.tsx
  - src/app/dashboard/videos/page.tsx
  - src/app/dashboard/assessments/page.tsx
  - src/app/dashboard/forms/pre-workout/page.tsx
  - src/app/dashboard/forms/post-workout/page.tsx
  - src/app/dashboard/forms/nutrition/page.tsx
  - src/app/admin/assessments/page.tsx
  - src/app/admin/assessments/[userId]/page.tsx
  - src/app/admin/assessments/[userId]/new/page.tsx
  - src/app/admin/submissions/page.tsx
  - src/app/admin/users/[userId]/page.tsx
  - src/app/admin/videos/page.tsx
  - src/components/dashboard/VideoCard.tsx
  - src/features/rankings/lib/actions/get-rankings.ts
  - src/features/goals/lib/actions/set-goal.ts
  - src/features/goals/lib/actions/delete-goal.ts
  - src/features/achievements/lib/actions/get-achievements.ts
  - src/lib/validations/profile.ts
autonomous: true

must_haves:
  truths:
    - "No 'as unknown as' patterns remain in codebase"
    - "Supabase types are regenerated and current"
    - "All Supabase queries use proper typing"
  artifacts:
    - path: "src/types/database.ts"
      provides: "Regenerated Supabase types with deleted_at"
      contains: "deleted_at"
      min_lines: 800
  key_links:
    - from: "All modified files"
      to: "src/types/database.ts"
      via: "Proper type imports"
      pattern: "from.*types/database"
---

<objective>
Replace all 'as unknown as' type assertion patterns with proper Supabase typing.

Purpose: Eliminate type safety bypasses that could hide bugs and security issues.
Output: All 19 files updated with proper typing, Supabase types regenerated.
</objective>

<execution_context>
@/Users/itayostraich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itayostraich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-fixes/01-CONTEXT.md
@.planning/phases/01-security-fixes/01-RESEARCH.md
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Regenerate Supabase types</name>
  <files>src/types/database.ts</files>
  <action>
Regenerate Supabase types to include new soft delete columns (deleted_at).

If Supabase CLI is linked:
```bash
npx supabase gen types typescript --project-id "$SUPABASE_PROJECT_ID" > src/types/database.ts
```

If not linked or command fails, manually add deleted_at to the types:

1. Add to profiles Row, Insert, Update:
   ```typescript
   deleted_at: string | null;  // for Row
   deleted_at?: string | null; // for Insert and Update
   ```

2. Add to player_assessments Row, Insert, Update:
   ```typescript
   deleted_at: string | null;  // for Row
   deleted_at?: string | null; // for Insert and Update
   ```

After regeneration/manual update, verify helper types at bottom of file still export correctly.
  </action>
  <verify>
```bash
grep "deleted_at" src/types/database.ts | wc -l  # Should be 6+ (2 tables x 3 type definitions)
npx tsc --noEmit src/types/database.ts
```
  </verify>
  <done>
- src/types/database.ts includes deleted_at in profiles and player_assessments
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix dashboard page type assertions</name>
  <files>src/app/dashboard/page.tsx</files>
  <action>
Fix the 10 `as unknown as` patterns in src/app/dashboard/page.tsx.

The issue is Supabase query chaining loses type info. Fix by:

1. Import proper types from database.ts if not already imported

2. For each query, use one of these approaches:

**Approach A: Type the response directly**
```typescript
const { data: profile } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", user?.id || "")
  .single();
// profile is already typed as Profile | null
```

**Approach B: Use explicit return type with proper assertion**
If the chain loses types, create a helper:
```typescript
import type { Database } from "@/types/database";
type Tables = Database["public"]["Tables"];

async function getProfile(supabase: SupabaseClient, userId: string) {
  const { data } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", userId)
    .single();
  return data as Tables["profiles"]["Row"] | null;
}
```

**Approach C: Inline type assertion (if simple)**
```typescript
const { data: profile } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", user?.id || "")
  .single() as { data: Profile | null };
```

For this file, Approach C is acceptable since it's a simple assertion and the queries are straightforward. The goal is to remove `as unknown as` not `as Type`.

Replace each pattern:
- `as unknown as { data: Profile | null }` -> `as { data: Profile | null }`
- `as unknown as { count: number | null }` -> `as { count: number | null }`
- etc.

This removes the unsafe `unknown` intermediate step while maintaining necessary type assertions.
  </action>
  <verify>
```bash
grep "as unknown as" src/app/dashboard/page.tsx | wc -l  # Should be 0
npx tsc --noEmit src/app/dashboard/page.tsx
```
  </verify>
  <done>
- No `as unknown as` patterns in src/app/dashboard/page.tsx
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix remaining files with type assertions</name>
  <files>Multiple files (see files_modified list)</files>
  <action>
Apply the same fix to all remaining files with `as unknown as` patterns.

Files to fix (run this command to get current list):
```bash
grep -r "as unknown as" src/ --include="*.ts" --include="*.tsx" -l
```

For each file, replace `as unknown as { ... }` with `as { ... }`.

Special cases:

1. **src/lib/validations/profile.ts** (line 27):
   ```typescript
   // Current:
   .enum(POSITIONS as unknown as [string, ...string[]])
   // Fix: Create properly typed tuple
   const POSITIONS_TUPLE = POSITIONS as [typeof POSITIONS[0], ...typeof POSITIONS[number][]];
   // Or if POSITIONS is a const array:
   .enum(POSITIONS as const)
   ```

2. **src/app/api/webhooks/grow/route.ts** (line 53):
   This is already handled in Plan 04 (webhook security) - skip this file.

3. **Form submission files** (pre-workout, post-workout, nutrition):
   These use `as unknown as { insert: ... }` pattern. Fix by:
   ```typescript
   // Instead of complex type assertion, use the typed client properly:
   const { error } = await supabase.from("pre_workout_forms").insert({
     // ... data
   });
   ```

4. **Action files** (get-rankings, set-goal, delete-goal, get-achievements):
   Similar pattern - remove `as unknown as` and use proper Supabase client typing.

Work through each file systematically. The build will catch any remaining issues.
  </action>
  <verify>
```bash
# Count remaining as unknown as patterns (excluding webhook route which is handled in Plan 04)
grep -r "as unknown as" src/ --include="*.ts" --include="*.tsx" | grep -v "webhooks/grow/route.ts" | wc -l  # Should be 0

# Full build check
npm run build
```
  </verify>
  <done>
- No `as unknown as` patterns remain (except webhook route handled in Plan 04)
- TypeScript build passes
- ESLint passes
  </done>
</task>

</tasks>

<verification>
1. Types regenerated: `grep "deleted_at" src/types/database.ts | wc -l` (6+)
2. No patterns remaining: `grep -r "as unknown as" src/ --include="*.ts" --include="*.tsx" | grep -v "webhooks" | wc -l` (0)
3. Build passes: `npm run build`
4. Lint passes: `npm run lint`
</verification>

<success_criteria>
- src/types/database.ts includes deleted_at for profiles and player_assessments
- Zero `as unknown as` patterns in codebase (except webhook which is fixed in Plan 04)
- TypeScript build passes without errors
- ESLint passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-fixes/01-05-SUMMARY.md`
</output>
